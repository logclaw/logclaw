{{- if .Values.flink.etlJob.enabled }}
apiVersion: flink.apache.org/v1beta1
kind: FlinkDeployment
metadata:
  name: {{ include "logclaw-flink.fullname" . }}-etl
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "logclaw-flink.labels" . | nindent 4 }}
    logclaw.io/job-name: etl
  annotations:
    logclaw.io/job-type: "etl"
    logclaw.io/slo: "parsing"
    logclaw.io/tenant-id: {{ include "logclaw-flink.tenantId" . | quote }}
spec:
  image: {{ (.Values.global).imageRegistry | default "docker.io" }}/logclaw-flink-jobs:{{ .Values.flink.jobImageTag }}
  imagePullPolicy: IfNotPresent
  flinkVersion: {{ include "logclaw-flink.flinkVersion" . }}
  flinkConfiguration:
    {{- include "logclaw-flink.flinkConfiguration" . | nindent 4 }}
  serviceAccount: {{ include "logclaw-flink.serviceAccountName" . }}
  jobManager:
    resource:
      memory: {{ .Values.flink.jobManager.memory | quote }}
      cpu: {{ .Values.flink.jobManager.cpu }}
    replicas: {{ .Values.flink.jobManager.replicas }}
  taskManager:
    resource:
      memory: {{ .Values.flink.taskManager.memory | quote }}
      cpu: {{ .Values.flink.taskManager.cpu }}
    replicas: {{ .Values.flink.taskManager.replicas }}
  job:
    jarURI: local:///opt/flink/jobs/logclaw-etl-{{ .Values.flink.jobImageTag }}.jar
    entryClass: "io.logclaw.flink.EtlParsingJob"
    parallelism: {{ .Values.flink.etlJob.parallelism }}
    upgradeMode: stateless
    args:
      - "--kafka.brokers={{ (.Values.global).kafkaBrokers | default "" }}"
      - "--kafka.input.topic={{ ((.Values.global).kafkaTopics).rawLogs | default "raw-logs" }}"
      - "--kafka.output.topic={{ ((.Values.global).kafkaTopics).enriched | default "enriched-logs" }}"
      - "--kafka.dlq.topic={{ ((.Values.global).kafkaTopics).dlq | default "dlq" }}"
      - "--tenant.id={{ include "logclaw-flink.tenantId" . }}"
    state: running
  podTemplate:
    spec:
      serviceAccountName: {{ include "logclaw-flink.serviceAccountName" . }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 9999
        fsGroup: 9999
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: flink-main-container
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: {{ (.Values.flink.taskManager.resources).requests | default dict | dig "cpu" "2" | quote }}
              memory: {{ (.Values.flink.taskManager.resources).requests | default dict | dig "memory" "4Gi" | quote }}
            limits:
              cpu: {{ (.Values.flink.taskManager.resources).limits | default dict | dig "cpu" "4" | quote }}
              memory: {{ (.Values.flink.taskManager.resources).limits | default dict | dig "memory" "8Gi" | quote }}
{{- end }}
