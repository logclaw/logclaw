apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "logclaw-dashboard.fullname" . }}-html
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "logclaw-dashboard.labels" . | nindent 4 }}
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>LogClaw Dashboard</title>
      <style>
        /* -- CSS Variables ------------------------------------------------- */
        :root {
          --bg-primary: #0f1117;
          --bg-surface: #1a1d27;
          --bg-surface-hover: #222636;
          --border: #2d3348;
          --border-light: #3d4560;
          --text: #e4e7ef;
          --text-muted: #8b92a8;
          --text-dim: #5a6178;
          --accent: #6c5ce7;
          --accent-light: #8577ed;
          --green: #00cec9;
          --green-dim: rgba(0,206,201,0.15);
          --red: #ff6b6b;
          --red-dim: rgba(255,107,107,0.15);
          --orange: #fdcb6e;
          --orange-dim: rgba(253,203,110,0.15);
          --blue: #74b9ff;
          --blue-dim: rgba(116,185,255,0.15);
          --purple-dim: rgba(108,92,231,0.15);
          --radius: 8px;
          --radius-lg: 12px;
          --shadow: 0 2px 8px rgba(0,0,0,0.3);
          --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          --font-mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
        }

        /* -- Reset & Base -------------------------------------------------- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 14px; }
        body {
          font-family: var(--font);
          background: var(--bg-primary);
          color: var(--text);
          line-height: 1.5;
          min-height: 100vh;
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* -- Layout -------------------------------------------------------- */
        .container { max-width: 1440px; margin: 0 auto; padding: 0 24px 48px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

        /* -- Header -------------------------------------------------------- */
        .header {
          display: flex; align-items: center; justify-content: space-between;
          padding: 16px 24px; border-bottom: 1px solid var(--border);
          background: var(--bg-surface); position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .logo {
          font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px;
          background: linear-gradient(135deg, var(--accent), var(--green));
          -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .cluster-badge {
          background: var(--purple-dim); color: var(--accent-light);
          padding: 4px 12px; border-radius: 20px; font-size: 0.75rem;
          font-weight: 600; border: 1px solid rgba(108,92,231,0.3);
        }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .live-dot {
          width: 8px; height: 8px; border-radius: 50%; background: var(--green);
          animation: pulse 2s ease-in-out infinite; display: inline-block;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .live-label { font-size: 0.8rem; color: var(--green); font-weight: 600; }

        /* -- Buttons ------------------------------------------------------- */
        .btn {
          padding: 6px 14px; border-radius: var(--radius); border: 1px solid var(--border);
          background: var(--bg-surface); color: var(--text); cursor: pointer;
          font-size: 0.8rem; font-weight: 500; transition: all 0.15s;
        }
        .btn:hover { border-color: var(--accent); background: var(--bg-surface-hover); }
        .btn-accent { background: var(--accent); border-color: var(--accent); color: #fff; }
        .btn-accent:hover { background: var(--accent-light); }
        .btn-sm { padding: 3px 10px; font-size: 0.7rem; }
        .btn-green { background: rgba(0,206,201,0.15); border-color: var(--green); color: var(--green); }
        .btn-green:hover { background: rgba(0,206,201,0.25); }
        .btn-orange { background: var(--orange-dim); border-color: var(--orange); color: var(--orange); }
        .btn-orange:hover { background: rgba(253,203,110,0.25); }
        .btn-blue { background: var(--blue-dim); border-color: var(--blue); color: var(--blue); }
        .btn-blue:hover { background: rgba(116,185,255,0.25); }
        .btn-red { background: var(--red-dim); border-color: var(--red); color: var(--red); }
        .btn-red:hover { background: rgba(255,107,107,0.25); }
        .btn-toggle { position: relative; }
        .btn-toggle.active { background: var(--accent); border-color: var(--accent); color: #fff; }

        /* -- Tab Navigation ------------------------------------------------ */
        .tab-nav {
          display: flex; gap: 0; border-bottom: 1px solid var(--border);
          background: var(--bg-surface); padding: 0 24px;
        }
        .tab-btn {
          padding: 12px 20px; border: none; background: none; color: var(--text-muted);
          font-size: 0.85rem; font-weight: 600; cursor: pointer; position: relative;
          transition: color 0.15s; border-bottom: 2px solid transparent; margin-bottom: -1px;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--accent-light); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* -- Section titles ------------------------------------------------ */
        .section-title {
          font-size: 1rem; font-weight: 600; margin: 28px 0 14px;
          display: flex; align-items: center; gap: 8px;
        }
        .section-title .icon { font-size: 1.1rem; }

        /* -- Card ---------------------------------------------------------- */
        .card {
          background: var(--bg-surface); border: 1px solid var(--border);
          border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow);
        }
        .card-header {
          display: flex; align-items: center; justify-content: space-between;
          margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
        }
        .card-title {
          font-size: 0.85rem; font-weight: 600; color: var(--text-muted);
          text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* -- Drag & Drop Zone ---------------------------------------------- */
        .drop-zone {
          border: 2px dashed var(--border-light); border-radius: var(--radius-lg);
          padding: 32px; text-align: center; cursor: pointer; transition: all 0.2s;
          background: var(--bg-surface); margin-top: 20px;
        }
        .drop-zone:hover, .drop-zone.drag-over {
          border-color: var(--accent); background: var(--purple-dim);
        }
        .drop-zone-icon { font-size: 2.5rem; margin-bottom: 8px; opacity: 0.6; }
        .drop-zone-text { color: var(--text-muted); font-size: 0.9rem; }
        .drop-zone-text strong { color: var(--accent-light); }
        .drop-zone-hint { color: var(--text-dim); font-size: 0.75rem; margin-top: 6px; }
        .progress-bar-container {
          width: 100%; background: var(--bg-primary); border-radius: 4px;
          height: 6px; margin-top: 12px; overflow: hidden; display: none;
        }
        .progress-bar {
          height: 100%; background: linear-gradient(90deg, var(--accent), var(--green));
          border-radius: 4px; width: 0%; transition: width 0.3s;
        }
        .upload-status { color: var(--text-muted); font-size: 0.8rem; margin-top: 8px; display: none; }

        /* -- Stats Cards --------------------------------------------------- */
        .stats-row {
          display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 14px; margin-top: 20px;
        }
        .stat-card {
          background: var(--bg-surface); border: 1px solid var(--border);
          border-radius: var(--radius-lg); padding: 18px 20px; cursor: default;
          transition: border-color 0.15s;
        }
        .stat-card:hover { border-color: var(--border-light); }
        .stat-card.clickable { cursor: pointer; }
        .stat-card.clickable:hover { border-color: var(--accent); }
        .stat-card.clickable.selected { border-color: var(--accent); background: var(--purple-dim); }
        .stat-label {
          font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;
          letter-spacing: 0.5px; font-weight: 600;
        }
        .stat-value {
          font-size: 1.8rem; font-weight: 700; margin-top: 4px;
          font-variant-numeric: tabular-nums;
        }
        .stat-sub { font-size: 0.75rem; color: var(--text-dim); margin-top: 2px; }
        .stat-green { color: var(--green); }
        .stat-red { color: var(--red); }
        .stat-blue { color: var(--blue); }
        .stat-orange { color: var(--orange); }
        .stat-accent { color: var(--accent-light); }

        /* -- Pipeline Flow ------------------------------------------------- */
        .pipeline-flow {
          display: flex; align-items: center; justify-content: center;
          gap: 0; padding: 24px 12px; overflow-x: auto; flex-wrap: nowrap;
        }
        .pipeline-node {
          display: flex; flex-direction: column; align-items: center;
          min-width: 100px; flex-shrink: 0;
        }
        .pipeline-node-box {
          background: var(--bg-surface-hover); border: 1px solid var(--border);
          border-radius: var(--radius); padding: 12px 16px; text-align: center;
          min-width: 90px; transition: all 0.2s; position: relative;
        }
        .pipeline-node-box.healthy { border-color: rgba(0,206,201,0.4); }
        .pipeline-node-box.warning { border-color: rgba(253,203,110,0.4); }
        .pipeline-node-box.error { border-color: rgba(255,107,107,0.4); }
        .pipeline-node-box.inactive { border-color: var(--border); opacity: 0.5; }
        .pipeline-node-name { font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; }
        .pipeline-node-count { font-size: 1.1rem; font-weight: 700; font-variant-numeric: tabular-nums; }
        .pipeline-node-icon { font-size: 1.2rem; margin-bottom: 4px; }
        .pipeline-node-status {
          position: absolute; top: -4px; right: -4px; width: 10px; height: 10px;
          border-radius: 50%; border: 2px solid var(--bg-surface);
        }
        .pipeline-node-status.green { background: var(--green); }
        .pipeline-node-status.yellow { background: var(--orange); }
        .pipeline-node-status.red { background: var(--red); }
        .pipeline-node-status.gray { background: var(--text-dim); }
        .pipeline-arrow {
          color: var(--text-dim); font-size: 1.2rem; margin: 0 4px; flex-shrink: 0;
          display: flex; align-items: center; position: relative;
        }
        .pipeline-arrow .arrow-line {
          width: 32px; height: 2px; background: var(--border-light); position: relative;
        }
        .pipeline-arrow .arrow-line::after {
          content: ''; position: absolute; right: -1px; top: -4px;
          border: 5px solid transparent; border-left-color: var(--border-light);
        }
        @keyframes flowPulse {
          0% { background-position: 0% 50%; }
          100% { background-position: 200% 50%; }
        }
        .pipeline-arrow.animated .arrow-line {
          background: linear-gradient(90deg, var(--border-light), var(--green), var(--border-light));
          background-size: 200% 100%;
          animation: flowPulse 2s linear infinite;
        }
        .pipeline-arrow.animated .arrow-line::after {
          border-left-color: var(--green);
        }

        /* -- Bar Charts ---------------------------------------------------- */
        .bar-chart { display: flex; flex-direction: column; gap: 8px; }
        .bar-row { display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 80px; font-size: 0.8rem; color: var(--text-muted); text-align: right; flex-shrink: 0; }
        .bar-track { flex: 1; height: 22px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding-left: 8px; }
        .bar-fill-text { font-size: 0.7rem; font-weight: 600; color: #fff; white-space: nowrap; }
        .bar-count { width: 60px; font-size: 0.8rem; color: var(--text-muted); font-variant-numeric: tabular-nums; }

        /* -- Badges -------------------------------------------------------- */
        .badge {
          display: inline-block; padding: 2px 8px; border-radius: 4px;
          font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .badge-error { background: var(--red-dim); color: var(--red); }
        .badge-warn { background: var(--orange-dim); color: var(--orange); }
        .badge-info { background: var(--green-dim); color: var(--green); }
        .badge-debug { background: var(--blue-dim); color: var(--blue); }
        .badge-fatal { background: var(--red); color: #fff; }
        .badge-critical { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }
        .badge-high { background: rgba(225,112,85,0.15); color: #e17055; border: 1px solid #e17055; }
        .badge-medium { background: var(--orange-dim); color: var(--orange); border: 1px solid var(--orange); }
        .badge-low { background: var(--blue-dim); color: var(--blue); border: 1px solid var(--blue); }
        .badge-sev-critical { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }
        .badge-sev-high { background: rgba(225,112,85,0.15); color: #e17055; border: 1px solid #e17055; }
        .badge-sev-medium { background: var(--orange-dim); color: var(--orange); border: 1px solid var(--orange); }
        .badge-sev-low { background: var(--blue-dim); color: var(--blue); border: 1px solid var(--blue); }

        /* -- Incident state badges ----------------------------------------- */
        .state-badge { padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .state-identified { background: var(--red-dim); color: var(--red); }
        .state-acknowledged { background: var(--orange-dim); color: var(--orange); }
        .state-investigating { background: var(--blue-dim); color: var(--blue); }
        .state-mitigated { background: rgba(0,206,201,0.1); color: rgba(0,206,201,0.7); }
        .state-resolved { background: var(--green-dim); color: var(--green); }

        /* -- Incident Cards ------------------------------------------------ */
        .incident-list { display: flex; flex-direction: column; gap: 12px; }
        .incident-card {
          background: var(--bg-surface); border: 1px solid var(--border);
          border-radius: var(--radius); padding: 16px 20px; cursor: pointer;
          transition: all 0.15s;
        }
        .incident-card:hover { border-color: var(--accent); background: var(--bg-surface-hover); }
        .incident-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .incident-card-title { font-size: 0.9rem; font-weight: 600; flex: 1; min-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .incident-card-meta { display: flex; align-items: center; gap: 16px; font-size: 0.8rem; color: var(--text-muted); flex-wrap: wrap; }
        .incident-card-meta span { display: flex; align-items: center; gap: 4px; }
        .incident-card-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; flex-wrap: wrap; gap: 8px; }
        .incident-card-actions { display: flex; gap: 6px; }
        .anomaly-score-bar {
          width: 120px; height: 6px; background: var(--bg-primary); border-radius: 3px;
          overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 6px;
        }
        .anomaly-score-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }

        /* -- Filter Bar ---------------------------------------------------- */
        .filter-bar {
          display: flex; align-items: center; gap: 12px; margin: 16px 0;
          flex-wrap: wrap;
        }
        .filter-select {
          padding: 7px 12px; border-radius: var(--radius); border: 1px solid var(--border);
          background: var(--bg-surface); color: var(--text); font-size: 0.8rem;
          cursor: pointer; min-width: 140px;
        }
        .filter-select:focus { border-color: var(--accent); outline: none; }
        .filter-input {
          padding: 7px 12px; border-radius: var(--radius); border: 1px solid var(--border);
          background: var(--bg-surface); color: var(--text); font-size: 0.8rem;
          flex: 1; min-width: 180px;
        }
        .filter-input:focus { border-color: var(--accent); outline: none; }
        .filter-input::placeholder { color: var(--text-dim); }

        /* -- Modal --------------------------------------------------------- */
        .modal-overlay {
          display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.6); z-index: 1000; align-items: center;
          justify-content: center; padding: 24px;
        }
        .modal-overlay.open { display: flex; }
        .modal {
          background: var(--bg-surface); border: 1px solid var(--border);
          border-radius: var(--radius-lg); width: 100%; max-width: 800px;
          max-height: 85vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .modal-header {
          display: flex; align-items: center; justify-content: space-between;
          padding: 20px 24px; border-bottom: 1px solid var(--border);
          position: sticky; top: 0; background: var(--bg-surface); z-index: 10;
        }
        .modal-header h2 { font-size: 1.1rem; font-weight: 700; }
        .modal-close {
          background: none; border: none; color: var(--text-muted); cursor: pointer;
          font-size: 1.5rem; line-height: 1; padding: 4px 8px;
        }
        .modal-close:hover { color: var(--text); }
        .modal-body { padding: 24px; }
        .modal-footer {
          padding: 16px 24px; border-top: 1px solid var(--border);
          display: flex; gap: 8px; justify-content: flex-end;
        }

        /* -- Detail fields ------------------------------------------------- */
        .detail-grid {
          display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;
        }
        @media (max-width: 600px) { .detail-grid { grid-template-columns: 1fr; } }
        .detail-field label {
          display: block; font-size: 0.7rem; color: var(--text-muted);
          text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 4px;
        }
        .detail-field .detail-value { font-size: 0.85rem; color: var(--text); }

        /* -- Timeline ------------------------------------------------------ */
        .timeline { position: relative; padding-left: 24px; margin: 16px 0; }
        .timeline::before {
          content: ''; position: absolute; left: 8px; top: 0; bottom: 0;
          width: 2px; background: var(--border);
        }
        .timeline-item { position: relative; margin-bottom: 16px; }
        .timeline-item::before {
          content: ''; position: absolute; left: -20px; top: 6px;
          width: 10px; height: 10px; border-radius: 50%; background: var(--accent);
          border: 2px solid var(--bg-surface);
        }
        .timeline-item .tl-time { font-size: 0.7rem; color: var(--text-dim); }
        .timeline-item .tl-text { font-size: 0.8rem; color: var(--text); margin-top: 2px; }
        .timeline-item .tl-actor { font-size: 0.7rem; color: var(--text-muted); margin-top: 1px; }

        /* -- Evidence table ------------------------------------------------ */
        .evidence-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .evidence-table th {
          text-align: left; padding: 8px 10px; font-size: 0.7rem; color: var(--text-muted);
          text-transform: uppercase; border-bottom: 1px solid var(--border); font-weight: 600;
        }
        .evidence-table td {
          padding: 6px 10px; font-size: 0.8rem; border-bottom: 1px solid rgba(45,51,72,0.4);
        }
        .evidence-table tr:hover { background: var(--bg-surface-hover); }

        /* -- External references ------------------------------------------- */
        .ext-refs { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .ext-ref-link {
          display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px;
          border-radius: var(--radius); border: 1px solid var(--border);
          background: var(--bg-surface-hover); color: var(--accent-light);
          text-decoration: none; font-size: 0.75rem; font-weight: 600;
          transition: border-color 0.15s;
        }
        .ext-ref-link:hover { border-color: var(--accent); }

        /* -- Integration cards --------------------------------------------- */
        .integration-grid {
          display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px;
        }
        .integration-card {
          background: var(--bg-surface); border: 1px solid var(--border);
          border-radius: var(--radius); padding: 20px; display: flex;
          align-items: center; gap: 16px;
        }
        .integration-icon { font-size: 2rem; flex-shrink: 0; }
        .integration-info { flex: 1; }
        .integration-name { font-size: 0.9rem; font-weight: 600; }
        .integration-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .integration-status {
          padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700;
          text-transform: uppercase;
        }
        .integration-status.connected { background: var(--green-dim); color: var(--green); }
        .integration-status.disconnected { background: rgba(139,146,168,0.15); color: var(--text-muted); }

        /* -- Tables -------------------------------------------------------- */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead th {
          text-align: left; padding: 10px 12px; font-size: 0.75rem;
          color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
          border-bottom: 1px solid var(--border); font-weight: 600; white-space: nowrap;
        }
        tbody td {
          padding: 8px 12px; border-bottom: 1px solid rgba(45,51,72,0.5);
          font-size: 0.8rem; vertical-align: top;
        }
        tbody tr:hover { background: var(--bg-surface-hover); }
        .mono { font-family: var(--font-mono); font-size: 0.75rem; }
        .truncate { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .table-empty { padding: 32px; text-align: center; color: var(--text-dim); font-size: 0.85rem; }
        .loading { color: var(--text-dim); font-size: 0.85rem; padding: 24px; text-align: center; }
        .error-msg { color: var(--red); font-size: 0.8rem; padding: 12px; text-align: center; }

        /* -- Log search bar ------------------------------------------------ */
        .log-search-bar {
          display: flex; gap: 12px; align-items: center; margin-bottom: 16px;
        }
        .log-search-input {
          flex: 1; padding: 8px 14px; border-radius: var(--radius);
          border: 1px solid var(--border); background: var(--bg-primary);
          color: var(--text); font-size: 0.85rem;
        }
        .log-search-input:focus { border-color: var(--accent); outline: none; }
        .log-search-input::placeholder { color: var(--text-dim); }

        /* -- Settings section ---------------------------------------------- */
        .settings-section { margin-bottom: 28px; }
        .settings-section-title {
          font-size: 0.9rem; font-weight: 600; margin-bottom: 14px;
          padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
      </style>
    </head>
    <body>

    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <span class="logo">LogClaw</span>
        <span class="cluster-badge" id="clusterBadge">--</span>
      </div>
      <div class="header-right">
        <span class="live-dot" id="liveDot"></span>
        <span class="live-label">LIVE</span>
        <button class="btn btn-toggle active" id="autoRefreshBtn" title="Toggle auto-refresh">Auto-Refresh</button>
        <button class="btn" id="manualRefreshBtn">Refresh</button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
      <button class="tab-btn active" data-tab="pipeline">Pipeline</button>
      <button class="tab-btn" data-tab="incidents">Incidents</button>
      <button class="tab-btn" data-tab="logs">Logs</button>
      <button class="tab-btn" data-tab="settings">Settings</button>
    </nav>

    <div class="container">

      <!-- ============================================================= -->
      <!-- TAB 1: PIPELINE                                               -->
      <!-- ============================================================= -->
      <div class="tab-content active" id="tab-pipeline">

        <!-- Drag & Drop Upload -->
        <div class="section-title"><span class="icon">&#128229;</span> Log File Upload</div>
        <div class="drop-zone" id="dropZone">
          <div class="drop-zone-icon">&#128195;</div>
          <div class="drop-zone-text">Drag &amp; drop log files here or <strong>click to browse</strong></div>
          <div class="drop-zone-hint">.log, .json, .ndjson, .csv, .txt supported</div>
          <div class="progress-bar-container" id="uploadProgress">
            <div class="progress-bar" id="uploadProgressBar"></div>
          </div>
          <div class="upload-status" id="uploadStatus"></div>
        </div>
        <input type="file" id="fileInput" multiple accept=".log,.json,.ndjson,.csv,.txt" style="display:none">

        <!-- Pipeline Flow -->
        <div class="section-title"><span class="icon">&#9881;</span> Pipeline Flow</div>
        <div class="card">
          <div class="pipeline-flow" id="pipelineFlow"></div>
        </div>

        <!-- Stats Cards -->
        <div class="section-title"><span class="icon">&#128200;</span> Pipeline Overview</div>
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Total Logs</div>
            <div class="stat-value stat-accent" id="statTotal">--</div>
            <div class="stat-sub">all indices</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Services</div>
            <div class="stat-value stat-blue" id="statServices">--</div>
            <div class="stat-sub">unique</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Error Rate</div>
            <div class="stat-value stat-red" id="statErrorRate">--</div>
            <div class="stat-sub">ERROR + FATAL</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Anomalies</div>
            <div class="stat-value stat-orange" id="statAnomalies">--</div>
            <div class="stat-sub">detected</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Incidents</div>
            <div class="stat-value stat-green" id="statIncidents">--</div>
            <div class="stat-sub">open</div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid-2">
          <div>
            <div class="section-title"><span class="icon">&#128202;</span> Log Level Distribution</div>
            <div class="card">
              <div class="bar-chart" id="levelChart"><div class="loading">Loading...</div></div>
            </div>
          </div>
          <div>
            <div class="section-title"><span class="icon">&#128187;</span> Top Services by Volume</div>
            <div class="card">
              <div class="bar-chart" id="serviceChart"><div class="loading">Loading...</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================================= -->
      <!-- TAB 2: INCIDENTS                                              -->
      <!-- ============================================================= -->
      <div class="tab-content" id="tab-incidents">

        <!-- Incident Summary Bar -->
        <div class="section-title"><span class="icon">&#128680;</span> Incident Overview</div>
        <div class="stats-row" id="incidentSummaryBar">
          <div class="stat-card clickable" data-state-filter="all">
            <div class="stat-label">Total</div>
            <div class="stat-value stat-accent" id="incTotal">--</div>
          </div>
          <div class="stat-card clickable" data-state-filter="identified">
            <div class="stat-label">Identified</div>
            <div class="stat-value stat-red" id="incIdentified">--</div>
          </div>
          <div class="stat-card clickable" data-state-filter="acknowledged">
            <div class="stat-label">Acknowledged</div>
            <div class="stat-value stat-orange" id="incAcknowledged">--</div>
          </div>
          <div class="stat-card clickable" data-state-filter="investigating">
            <div class="stat-label">Investigating</div>
            <div class="stat-value stat-blue" id="incInvestigating">--</div>
          </div>
          <div class="stat-card clickable" data-state-filter="mitigated">
            <div class="stat-label">Mitigated</div>
            <div class="stat-value" style="color:rgba(0,206,201,0.7)" id="incMitigated">--</div>
          </div>
          <div class="stat-card clickable" data-state-filter="resolved">
            <div class="stat-label">Resolved</div>
            <div class="stat-value stat-green" id="incResolved">--</div>
          </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
          <select class="filter-select" id="filterState">
            <option value="">All States</option>
            <option value="identified">Identified</option>
            <option value="acknowledged">Acknowledged</option>
            <option value="investigating">Investigating</option>
            <option value="mitigated">Mitigated</option>
            <option value="resolved">Resolved</option>
          </select>
          <select class="filter-select" id="filterSeverity">
            <option value="">All Severities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
          <select class="filter-select" id="filterService">
            <option value="">All Services</option>
          </select>
          <input type="text" class="filter-input" id="filterSearch" placeholder="Search incidents...">
        </div>

        <!-- Incident List -->
        <div class="incident-list" id="incidentList">
          <div class="loading">Loading incidents...</div>
        </div>
      </div>

      <!-- ============================================================= -->
      <!-- TAB 3: LOGS                                                   -->
      <!-- ============================================================= -->
      <div class="tab-content" id="tab-logs">

        <!-- Error Logs -->
        <div class="section-title"><span class="icon">&#128308;</span> Error Logs (Recent 50)</div>
        <div class="card">
          <div class="table-wrapper">
            <table>
              <thead><tr>
                <th>Time</th><th>Level</th><th>Service</th><th>Message</th><th>Trace ID</th>
              </tr></thead>
              <tbody id="errorBody"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- Log Stream -->
        <div class="section-title"><span class="icon">&#128220;</span> Log Stream (Latest 100)</div>
        <div class="card">
          <div class="log-search-bar">
            <input type="text" class="log-search-input" id="logSearchInput" placeholder="Filter logs by keyword...">
          </div>
          <div class="table-wrapper">
            <table>
              <thead><tr>
                <th>Time</th><th>Level</th><th>Service</th><th>Host</th><th>Message</th>
              </tr></thead>
              <tbody id="logBody"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================================================= -->
      <!-- TAB 4: SETTINGS                                               -->
      <!-- ============================================================= -->
      <div class="tab-content" id="tab-settings">

        <div class="section-title"><span class="icon">&#128268;</span> Integration Status</div>
        <div class="settings-section">
          <div class="integration-grid" id="integrationGrid">
            <div class="loading">Loading integrations...</div>
          </div>
        </div>
      </div>

    </div><!-- /container -->

    <!-- Incident Detail Modal -->
    <div class="modal-overlay" id="incidentModal">
      <div class="modal">
        <div class="modal-header">
          <h2 id="modalTitle">Incident Details</h2>
          <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
          <div class="loading">Loading...</div>
        </div>
        <div class="modal-footer" id="modalFooter"></div>
      </div>
    </div>

    <script>
    (function() {
      "use strict";

      /* ================================================================= */
      /* HELPERS                                                           */
      /* ================================================================= */
      function fmt(n) {
        if (n == null || isNaN(n)) return "--";
        if (n >= 1e6) return (n / 1e6).toFixed(1) + "M";
        if (n >= 1e3) return (n / 1e3).toFixed(1) + "K";
        return String(n);
      }

      function esc(s) {
        if (!s) return "";
        var d = document.createElement("div");
        d.textContent = String(s);
        return d.innerHTML;
      }

      function timeAgo(isoString) {
        if (!isoString) return "--";
        try {
          var now = Date.now();
          var then = new Date(isoString).getTime();
          var diff = Math.max(0, now - then);
          var secs = Math.floor(diff / 1000);
          if (secs < 60) return secs + "s ago";
          var mins = Math.floor(secs / 60);
          if (mins < 60) return mins + "m ago";
          var hrs = Math.floor(mins / 60);
          if (hrs < 24) return hrs + "h ago";
          var days = Math.floor(hrs / 24);
          return days + "d ago";
        } catch(e) { return "--"; }
      }

      function relTime(ts) {
        if (!ts) return "--";
        try {
          var d = new Date(ts);
          return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        } catch(e) { return "--"; }
      }

      function fullTime(ts) {
        if (!ts) return "--";
        try {
          var d = new Date(ts);
          return d.toLocaleString();
        } catch(e) { return "--"; }
      }

      function levelBadge(level) {
        if (!level) return "";
        var l = level.toUpperCase();
        var cls = "badge-debug";
        if (l === "ERROR") cls = "badge-error";
        else if (l === "FATAL") cls = "badge-fatal";
        else if (l === "WARN" || l === "WARNING") cls = "badge-warn";
        else if (l === "INFO") cls = "badge-info";
        return '<span class="badge ' + cls + '">' + esc(l) + '</span>';
      }

      function severityBadge(sev) {
        if (!sev) return '<span class="badge badge-sev-low">UNKNOWN</span>';
        var s = sev.toLowerCase();
        var cls = "badge-sev-low";
        if (s === "critical") cls = "badge-sev-critical";
        else if (s === "high") cls = "badge-sev-high";
        else if (s === "medium") cls = "badge-sev-medium";
        return '<span class="badge ' + cls + '">' + esc(sev.toUpperCase()) + '</span>';
      }

      function stateBadge(st) {
        if (!st) return '<span class="state-badge state-identified">UNKNOWN</span>';
        var s = st.toLowerCase();
        var cls = "state-identified";
        if (s === "acknowledged") cls = "state-acknowledged";
        else if (s === "investigating") cls = "state-investigating";
        else if (s === "mitigated") cls = "state-mitigated";
        else if (s === "resolved") cls = "state-resolved";
        return '<span class="state-badge ' + cls + '">' + esc(st.toUpperCase()) + '</span>';
      }

      function scoreColor(score) {
        var n = Number(score);
        if (n > 0.8) return "var(--red)";
        if (n > 0.5) return "var(--orange)";
        return "var(--green)";
      }

      var LEVEL_COLORS = {
        "FATAL": "#8b0000", "ERROR": "var(--red)",
        "WARN": "var(--orange)", "WARNING": "var(--orange)",
        "INFO": "var(--blue)", "DEBUG": "var(--text-dim)", "TRACE": "var(--text-dim)"
      };

      var SVC_COLORS = [
        "var(--accent)", "var(--green)", "var(--blue)", "var(--orange)", "var(--red)",
        "var(--accent-light)", "#e17055", "#00b894", "#0984e3", "#fd79a8"
      ];

      /* ================================================================= */
      /* SAFE FETCH                                                        */
      /* ================================================================= */
      function safeFetch(url, opts) {
        return fetch(url, Object.assign({signal: AbortSignal.timeout(15000)}, opts || {}))
          .then(function(r) {
            if (!r.ok) throw new Error("HTTP " + r.status);
            return r.json();
          });
      }

      /* ================================================================= */
      /* STATE                                                             */
      /* ================================================================= */
      var state = {
        totalLogs: 0, anomalyCount: 0, errorRate: 0,
        serviceCount: 0, incidentCount: 0,
        autoRefresh: true, refreshTimer: null,
        currentTab: "pipeline",
        incidents: [], incidentStats: {},
        allLogHits: [], services: [],
        pipelineHealthy: false
      };

      /* ================================================================= */
      /* TAB SWITCHING                                                     */
      /* ================================================================= */
      function showTab(name) {
        state.currentTab = name;
        document.querySelectorAll(".tab-btn").forEach(function(b) {
          b.classList.toggle("active", b.getAttribute("data-tab") === name);
        });
        document.querySelectorAll(".tab-content").forEach(function(c) {
          c.classList.toggle("active", c.id === "tab-" + name);
        });
        if (name === "incidents") {
          fetchIncidentStats();
          fetchIncidents();
        } else if (name === "logs") {
          fetchErrorLogs();
          fetchLogStream();
        } else if (name === "settings") {
          fetchIntegrations();
        }
      }
      window.showTab = showTab;

      /* ================================================================= */
      /* INIT                                                              */
      /* ================================================================= */
      function init() {
        setupTabNav();
        setupDropZone();
        setupAutoRefreshToggle();
        setupFilterListeners();
        setupModalListeners();
        setupIncidentDelegation();
        setupLogSearch();
        buildPipelineFlow();
        fetchHealth();
        refreshAll();
        state.refreshTimer = setInterval(function() {
          if (state.autoRefresh) refreshAll();
        }, 10000);
      }

      function setupTabNav() {
        document.querySelectorAll(".tab-btn").forEach(function(btn) {
          btn.addEventListener("click", function() {
            showTab(btn.getAttribute("data-tab"));
          });
        });
      }

      function setupAutoRefreshToggle() {
        var btn = document.getElementById("autoRefreshBtn");
        btn.addEventListener("click", function() {
          state.autoRefresh = !state.autoRefresh;
          btn.classList.toggle("active", state.autoRefresh);
          var dot = document.getElementById("liveDot");
          dot.style.animationPlayState = state.autoRefresh ? "running" : "paused";
        });
        document.getElementById("manualRefreshBtn").addEventListener("click", function() {
          refreshAll();
        });
      }

      /* ================================================================= */
      /* REFRESH ALL                                                       */
      /* ================================================================= */
      function refreshAll() {
        fetchTotalCount();
        fetchLevelDistribution();
        fetchTopServices();
        fetchAnomalies();
        if (state.currentTab === "pipeline") {
          fetchIncidentStats();
        }
        if (state.currentTab === "incidents") {
          fetchIncidentStats();
          fetchIncidents();
        }
        if (state.currentTab === "logs") {
          fetchErrorLogs();
          fetchLogStream();
        }
        if (state.currentTab === "settings") {
          fetchIntegrations();
        }
      }
      window.refreshAll = refreshAll;

      /* ================================================================= */
      /* HEALTH CHECK                                                      */
      /* ================================================================= */
      function fetchHealth() {
        safeFetch("/health")
          .then(function(d) {
            var tenant = d.tenant || "unknown";
            document.getElementById("clusterBadge").textContent = tenant;
          })
          .catch(function() {});
      }

      /* ================================================================= */
      /* PIPELINE FLOW DIAGRAM                                             */
      /* ================================================================= */
      var pipelineNodes = [
        { id: "sources", icon: "&#128229;", name: "Sources", countId: "pnSources" },
        { id: "vector", icon: "&#10148;", name: "Vector", countId: "pnVector" },
        { id: "kafka", icon: "&#9889;", name: "Kafka", countId: "pnKafka" },
        { id: "bridge", icon: "&#128295;", name: "Bridge", countId: "pnBridge" },
        { id: "opensearch", icon: "&#128269;", name: "OpenSearch", countId: "pnOpenSearch" },
        { id: "incidents", icon: "&#128680;", name: "Incidents", countId: "pnIncidents" }
      ];

      function buildPipelineFlow() {
        var el = document.getElementById("pipelineFlow");
        var html = "";
        pipelineNodes.forEach(function(node, i) {
          html += '<div class="pipeline-node">' +
            '<div class="pipeline-node-box" id="pnBox_' + node.id + '">' +
            '<div class="pipeline-node-status gray" id="pnStatus_' + node.id + '"></div>' +
            '<div class="pipeline-node-icon">' + node.icon + '</div>' +
            '<div class="pipeline-node-name">' + node.name + '</div>' +
            '<div class="pipeline-node-count" id="' + node.countId + '">--</div>' +
            '</div></div>';
          if (i < pipelineNodes.length - 1) {
            html += '<div class="pipeline-arrow" id="pnArrow_' + i + '">' +
              '<div class="arrow-line"></div></div>';
          }
        });
        el.innerHTML = html;
      }

      function updatePipelineNode(id, count, healthy) {
        var box = document.getElementById("pnBox_" + id);
        var dot = document.getElementById("pnStatus_" + id);
        var countEl = document.getElementById(pipelineNodes.find(function(n){return n.id===id;}).countId);
        if (countEl) countEl.textContent = fmt(count);
        if (box) {
          box.classList.remove("healthy","warning","error","inactive");
          if (count > 0 && healthy !== false) box.classList.add("healthy");
          else if (healthy === false) box.classList.add("error");
          else box.classList.add("inactive");
        }
        if (dot) {
          dot.classList.remove("green","yellow","red","gray");
          if (count > 0 && healthy !== false) dot.classList.add("green");
          else if (healthy === false) dot.classList.add("red");
          else dot.classList.add("gray");
        }
      }

      function updatePipelineArrows(healthy) {
        for (var i = 0; i < pipelineNodes.length - 1; i++) {
          var arrow = document.getElementById("pnArrow_" + i);
          if (arrow) {
            if (healthy) arrow.classList.add("animated");
            else arrow.classList.remove("animated");
          }
        }
      }

      /* ================================================================= */
      /* TOTAL LOG COUNT                                                   */
      /* ================================================================= */
      function fetchTotalCount() {
        safeFetch("/api/opensearch/logclaw-logs-*/_count")
          .then(function(d) {
            state.totalLogs = d.count || 0;
            document.getElementById("statTotal").textContent = fmt(state.totalLogs);
            state.pipelineHealthy = true;
            updatePipelineNode("sources", state.totalLogs, true);
            updatePipelineNode("vector", state.totalLogs, true);
            updatePipelineNode("kafka", state.totalLogs, true);
            updatePipelineNode("opensearch", state.totalLogs, true);
            updatePipelineArrows(true);
          })
          .catch(function() {
            document.getElementById("statTotal").textContent = "--";
            state.pipelineHealthy = false;
            updatePipelineArrows(false);
          });
        /* Bridge metrics */
        safeFetch("/api/bridge/metrics")
          .then(function(d) {
            var count = d.processed || d.total || d.messages_forwarded || 0;
            updatePipelineNode("bridge", count, true);
          })
          .catch(function() {
            updatePipelineNode("bridge", 0, false);
          });
      }

      /* ================================================================= */
      /* LEVEL DISTRIBUTION                                                */
      /* ================================================================= */
      function fetchLevelDistribution() {
        var body = JSON.stringify({
          size: 0,
          aggs: { levels: { terms: { field: "level.keyword", size: 10 } } }
        });
        safeFetch("/api/opensearch/logclaw-logs-*/_search", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: body
        })
        .then(function(d) {
          var buckets = (d.aggregations && d.aggregations.levels && d.aggregations.levels.buckets) || [];
          var total = buckets.reduce(function(s, b) { return s + b.doc_count; }, 0) || 1;
          var errorCount = 0;
          buckets.forEach(function(b) {
            var l = (b.key || "").toUpperCase();
            if (l === "ERROR" || l === "FATAL") errorCount += b.doc_count;
          });
          state.errorRate = total > 0 ? ((errorCount / total) * 100).toFixed(1) : "0";
          document.getElementById("statErrorRate").textContent = state.errorRate + "%";

          /* Sort by severity order */
          var order = ["FATAL","ERROR","WARN","WARNING","INFO","DEBUG","TRACE"];
          buckets.sort(function(a,b) {
            var ai = order.indexOf((a.key||"").toUpperCase());
            var bi = order.indexOf((b.key||"").toUpperCase());
            if (ai === -1) ai = 99;
            if (bi === -1) bi = 99;
            return ai - bi;
          });

          var el = document.getElementById("levelChart");
          if (buckets.length === 0) {
            el.innerHTML = '<div class="table-empty">No data</div>';
            return;
          }
          var maxCount = Math.max.apply(null, buckets.map(function(b){return b.doc_count;}));
          var html = "";
          buckets.forEach(function(b) {
            var pct = maxCount > 0 ? Math.round((b.doc_count / maxCount) * 100) : 0;
            var color = LEVEL_COLORS[(b.key || "").toUpperCase()] || "var(--text-dim)";
            html += '<div class="bar-row">' +
              '<div class="bar-label">' + esc(b.key) + '</div>' +
              '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + color + '">' +
              '<span class="bar-fill-text">' + fmt(b.doc_count) + '</span></div></div>' +
              '<div class="bar-count">' + fmt(b.doc_count) + '</div></div>';
          });
          el.innerHTML = html;
        })
        .catch(function(e) {
          document.getElementById("levelChart").innerHTML = '<div class="error-msg">Failed to load: ' + esc(e.message) + '</div>';
        });
      }

      /* ================================================================= */
      /* TOP SERVICES                                                      */
      /* ================================================================= */
      function fetchTopServices() {
        var body = JSON.stringify({
          size: 0,
          aggs: { services: { terms: { field: "service.keyword", size: 10 } } }
        });
        safeFetch("/api/opensearch/logclaw-logs-*/_search", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: body
        })
        .then(function(d) {
          var buckets = (d.aggregations && d.aggregations.services && d.aggregations.services.buckets) || [];
          state.serviceCount = buckets.length;
          state.services = buckets.map(function(b) { return b.key; });
          document.getElementById("statServices").textContent = String(state.serviceCount);
          populateServiceFilter(state.services);

          var el = document.getElementById("serviceChart");
          if (buckets.length === 0) {
            el.innerHTML = '<div class="table-empty">No data</div>';
            return;
          }
          var maxCount = Math.max.apply(null, buckets.map(function(b){return b.doc_count;}));
          var html = "";
          buckets.forEach(function(b, i) {
            var pct = maxCount > 0 ? Math.round((b.doc_count / maxCount) * 100) : 0;
            html += '<div class="bar-row">' +
              '<div class="bar-label">' + esc(b.key) + '</div>' +
              '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + SVC_COLORS[i % SVC_COLORS.length] + '">' +
              '<span class="bar-fill-text">' + fmt(b.doc_count) + '</span></div></div>' +
              '<div class="bar-count">' + fmt(b.doc_count) + '</div></div>';
          });
          el.innerHTML = html;
        })
        .catch(function(e) {
          document.getElementById("serviceChart").innerHTML = '<div class="error-msg">Failed to load: ' + esc(e.message) + '</div>';
        });
      }

      /* ================================================================= */
      /* ANOMALIES                                                         */
      /* ================================================================= */
      function fetchAnomalies() {
        safeFetch("/api/opensearch/logclaw-anomalies-*/_count")
          .then(function(d) {
            state.anomalyCount = d.count || 0;
            document.getElementById("statAnomalies").textContent = fmt(state.anomalyCount);
          })
          .catch(function() {
            document.getElementById("statAnomalies").textContent = "--";
          });
      }

      /* ================================================================= */
      /* INCIDENT STATS                                                    */
      /* ================================================================= */
      function fetchIncidentStats() {
        safeFetch("/api/ticketing/api/stats")
          .then(function(d) {
            state.incidentStats = d;
            var total = d.total || 0;
            state.incidentCount = d.active || total;
            document.getElementById("statIncidents").textContent = fmt(state.incidentCount);
            updatePipelineNode("incidents", total, true);

            document.getElementById("incTotal").textContent = fmt(total);
            document.getElementById("incIdentified").textContent = fmt(d.identified || 0);
            document.getElementById("incAcknowledged").textContent = fmt(d.acknowledged || 0);
            document.getElementById("incInvestigating").textContent = fmt(d.investigating || 0);
            document.getElementById("incMitigated").textContent = fmt(d.mitigated || 0);
            document.getElementById("incResolved").textContent = fmt(d.resolved || 0);
          })
          .catch(function() {
            document.getElementById("statIncidents").textContent = "--";
            updatePipelineNode("incidents", 0, null);
          });
      }

      /* ================================================================= */
      /* INCIDENTS LIST                                                    */
      /* ================================================================= */
      function fetchIncidents() {
        var params = [];
        var stateVal = document.getElementById("filterState").value;
        var sevVal = document.getElementById("filterSeverity").value;
        var svcVal = document.getElementById("filterService").value;
        var searchVal = document.getElementById("filterSearch").value.trim();
        if (stateVal) params.push("state=" + encodeURIComponent(stateVal));
        if (sevVal) params.push("severity=" + encodeURIComponent(sevVal));
        if (svcVal) params.push("service=" + encodeURIComponent(svcVal));
        if (searchVal) params.push("q=" + encodeURIComponent(searchVal));

        var url = "/api/ticketing/api/incidents";
        if (params.length > 0) url += "?" + params.join("&");

        safeFetch(url)
          .then(function(d) {
            var list = Array.isArray(d) ? d : (d.incidents || d.data || []);
            state.incidents = list;
            renderIncidentList(list);
          })
          .catch(function(e) {
            document.getElementById("incidentList").innerHTML =
              '<div class="error-msg">Failed to load incidents: ' + esc(e.message) + '</div>';
          });
      }

      function renderIncidentList(incidents) {
        var el = document.getElementById("incidentList");
        if (!incidents || incidents.length === 0) {
          el.innerHTML = '<div class="table-empty">No incidents found</div>';
          return;
        }
        var html = "";
        incidents.forEach(function(inc) {
          var id = inc.id || inc.incident_id || "--";
          var title = inc.title || inc.subject || "Untitled Incident";
          var sev = inc.severity || "low";
          var st = inc.state || inc.status || "identified";
          var service = inc.service || inc.service_name || "--";
          var ts = inc.created_at || inc.timestamp || "";
          var score = inc.anomaly_score != null ? Number(inc.anomaly_score) : null;
          var stLower = st.toLowerCase();

          html += '<div class="incident-card" data-incident-id="' + esc(id) + '">';
          html += '<div class="incident-card-header">';
          html += severityBadge(sev) + ' ' + stateBadge(st);
          html += '<span class="incident-card-title">' + esc(title) + '</span>';
          html += '</div>';
          html += '<div class="incident-card-meta">';
          html += '<span><strong>ID:</strong> ' + esc(id) + '</span>';
          html += '<span><strong>Service:</strong> ' + esc(service) + '</span>';
          html += '<span>' + esc(timeAgo(ts)) + '</span>';
          if (score != null) {
            var pct = Math.round(score * 100);
            html += '<span>Score: ' + score.toFixed(2) +
              '<span class="anomaly-score-bar"><span class="anomaly-score-fill" style="width:' + pct + '%;background:' + scoreColor(score) + '"></span></span></span>';
          }
          html += '</div>';
          html += '<div class="incident-card-footer">';
          html += '<div class="incident-card-actions">';
          if (stLower === "identified") {
            html += '<button class="btn btn-sm btn-orange" data-action="acknowledge" data-id="' + esc(id) + '">Acknowledge</button>';
            html += '<button class="btn btn-sm btn-blue" data-action="investigate" data-id="' + esc(id) + '">Investigate</button>';
          } else if (stLower === "acknowledged") {
            html += '<button class="btn btn-sm btn-blue" data-action="investigate" data-id="' + esc(id) + '">Investigate</button>';
          } else if (stLower === "investigating") {
            html += '<button class="btn btn-sm btn-green" data-action="mitigate" data-id="' + esc(id) + '">Mitigate</button>';
          } else if (stLower === "mitigated") {
            html += '<button class="btn btn-sm btn-green" data-action="resolve" data-id="' + esc(id) + '">Resolve</button>';
          }
          if (stLower !== "resolved") {
            html += '<button class="btn btn-sm btn-green" data-action="resolve" data-id="' + esc(id) + '">Resolve</button>';
          }
          html += '</div></div></div>';
        });
        el.innerHTML = html;
      }

      function populateServiceFilter(services) {
        var sel = document.getElementById("filterService");
        var current = sel.value;
        /* Keep first option */
        while (sel.options.length > 1) sel.remove(1);
        services.forEach(function(s) {
          var opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      }

      /* ================================================================= */
      /* INCIDENT FILTER LISTENERS                                         */
      /* ================================================================= */
      function setupFilterListeners() {
        ["filterState","filterSeverity","filterService"].forEach(function(id) {
          document.getElementById(id).addEventListener("change", function() {
            fetchIncidents();
          });
        });
        var searchInput = document.getElementById("filterSearch");
        var searchTimer;
        searchInput.addEventListener("input", function() {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(function() { fetchIncidents(); }, 400);
        });

        /* Summary card click filters */
        document.getElementById("incidentSummaryBar").addEventListener("click", function(e) {
          var card = e.target.closest(".stat-card[data-state-filter]");
          if (!card) return;
          var filter = card.getAttribute("data-state-filter");
          var sel = document.getElementById("filterState");
          if (filter === "all") {
            sel.value = "";
          } else {
            sel.value = filter;
          }
          /* Visual selection */
          document.querySelectorAll("#incidentSummaryBar .stat-card").forEach(function(c) {
            c.classList.remove("selected");
          });
          card.classList.add("selected");
          fetchIncidents();
        });
      }

      /* ================================================================= */
      /* INCIDENT ACTIONS (event delegation)                               */
      /* ================================================================= */
      function setupIncidentDelegation() {
        document.getElementById("incidentList").addEventListener("click", function(e) {
          /* Action button click */
          var actionBtn = e.target.closest("[data-action]");
          if (actionBtn) {
            e.stopPropagation();
            var action = actionBtn.getAttribute("data-action");
            var id = actionBtn.getAttribute("data-id");
            var stateMap = {
              "acknowledge": "acknowledged",
              "investigate": "investigating",
              "mitigate": "mitigated",
              "resolve": "resolved"
            };
            var newState = stateMap[action];
            if (newState && id) {
              patchIncidentState(id, newState);
            }
            return;
          }
          /* Card click for detail */
          var card = e.target.closest(".incident-card");
          if (card) {
            var incId = card.getAttribute("data-incident-id");
            if (incId) openIncidentModal(incId);
          }
        });
      }

      function patchIncidentState(id, newState) {
        safeFetch("/api/ticketing/api/incidents/" + encodeURIComponent(id), {
          method: "PATCH",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ state: newState })
        })
        .then(function() {
          fetchIncidents();
          fetchIncidentStats();
        })
        .catch(function(e) {
          alert("Failed to update incident: " + e.message);
        });
      }

      /* ================================================================= */
      /* INCIDENT DETAIL MODAL                                             */
      /* ================================================================= */
      function setupModalListeners() {
        document.getElementById("modalClose").addEventListener("click", closeModal);
        document.getElementById("incidentModal").addEventListener("click", function(e) {
          if (e.target === this) closeModal();
        });
        document.addEventListener("keydown", function(e) {
          if (e.key === "Escape") closeModal();
        });
      }

      function closeModal() {
        document.getElementById("incidentModal").classList.remove("open");
      }

      function openIncidentModal(id) {
        var overlay = document.getElementById("incidentModal");
        var titleEl = document.getElementById("modalTitle");
        var bodyEl = document.getElementById("modalBody");
        var footerEl = document.getElementById("modalFooter");

        titleEl.textContent = "Incident " + id;
        bodyEl.innerHTML = '<div class="loading">Loading incident details...</div>';
        footerEl.innerHTML = "";
        overlay.classList.add("open");

        safeFetch("/api/ticketing/api/incidents/" + encodeURIComponent(id))
          .then(function(inc) {
            renderIncidentDetail(inc);
          })
          .catch(function(e) {
            bodyEl.innerHTML = '<div class="error-msg">Failed to load: ' + esc(e.message) + '</div>';
          });
      }

      function renderIncidentDetail(inc) {
        var bodyEl = document.getElementById("modalBody");
        var footerEl = document.getElementById("modalFooter");
        var titleEl = document.getElementById("modalTitle");

        var id = inc.id || inc.incident_id || "--";
        var title = inc.title || inc.subject || "Untitled";
        var desc = inc.description || inc.message || "";
        var sev = inc.severity || "low";
        var st = inc.state || inc.status || "identified";
        var service = inc.service || inc.service_name || "--";
        var assignee = inc.assigned_to || inc.assignee || "--";
        var createdAt = inc.created_at || inc.timestamp || "";
        var updatedAt = inc.updated_at || "";

        titleEl.textContent = "Incident " + id;

        var html = '';
        /* Detail grid */
        html += '<div class="detail-grid">';
        html += '<div class="detail-field"><label>Incident ID</label><div class="detail-value mono">' + esc(id) + '</div></div>';
        html += '<div class="detail-field"><label>Severity</label><div class="detail-value">' + severityBadge(sev) + '</div></div>';
        html += '<div class="detail-field"><label>State</label><div class="detail-value">' + stateBadge(st) + '</div></div>';
        html += '<div class="detail-field"><label>Service</label><div class="detail-value">' + esc(service) + '</div></div>';
        html += '<div class="detail-field"><label>Created</label><div class="detail-value">' + esc(fullTime(createdAt)) + '</div></div>';
        html += '<div class="detail-field"><label>Last Updated</label><div class="detail-value">' + esc(fullTime(updatedAt)) + '</div></div>';
        html += '<div class="detail-field"><label>Assigned To</label><div class="detail-value">' + esc(assignee) + '</div></div>';
        if (inc.anomaly_score != null) {
          var score = Number(inc.anomaly_score);
          html += '<div class="detail-field"><label>Anomaly Score</label><div class="detail-value" style="color:' + scoreColor(score) + '">' + score.toFixed(2) + '</div></div>';
        }
        html += '</div>';

        /* Title & Description */
        html += '<div class="detail-field" style="margin-bottom:16px"><label>Title</label><div class="detail-value">' + esc(title) + '</div></div>';
        if (desc) {
          html += '<div class="detail-field" style="margin-bottom:16px"><label>Description</label><div class="detail-value">' + esc(desc) + '</div></div>';
        }

        /* Timeline */
        var timeline = inc.timeline || inc.state_changes || inc.history || [];
        if (timeline.length > 0) {
          html += '<div class="detail-field"><label>Timeline</label></div>';
          html += '<div class="timeline">';
          timeline.forEach(function(entry) {
            var time = entry.timestamp || entry.created_at || entry.time || "";
            var text = entry.message || entry.description || ("State changed to " + (entry.state || entry.to || "unknown"));
            var actor = entry.actor || entry.user || entry.changed_by || "";
            html += '<div class="timeline-item">';
            html += '<div class="tl-time">' + esc(fullTime(time)) + '</div>';
            html += '<div class="tl-text">' + esc(text) + '</div>';
            if (actor) html += '<div class="tl-actor">by ' + esc(actor) + '</div>';
            html += '</div>';
          });
          html += '</div>';
        }

        /* Evidence logs */
        var evidence = inc.evidence_logs || inc.evidence || inc.logs || [];
        if (evidence.length > 0) {
          html += '<div class="detail-field" style="margin-top:16px"><label>Evidence Logs</label></div>';
          html += '<div class="table-wrapper"><table class="evidence-table">';
          html += '<thead><tr><th>Timestamp</th><th>Level</th><th>Message</th></tr></thead><tbody>';
          evidence.forEach(function(log) {
            var ts = log["@timestamp"] || log.timestamp || log.time || "";
            var lev = log.level || "";
            var msg = log.message || "";
            html += '<tr><td class="mono">' + esc(relTime(ts)) + '</td><td>' + levelBadge(lev) + '</td><td class="truncate">' + esc(msg) + '</td></tr>';
          });
          html += '</tbody></table></div>';
        }

        /* External references */
        var refs = inc.external_references || inc.references || inc.links || [];
        if (refs.length > 0) {
          html += '<div class="detail-field" style="margin-top:16px"><label>External References</label></div>';
          html += '<div class="ext-refs">';
          refs.forEach(function(ref) {
            var url = ref.url || ref.link || "#";
            var label = ref.label || ref.type || ref.provider || "Link";
            html += '<a class="ext-ref-link" href="' + esc(url) + '" target="_blank" rel="noopener">' + esc(label) + '</a>';
          });
          html += '</div>';
        }

        bodyEl.innerHTML = html;

        /* Footer action buttons */
        var stLower = st.toLowerCase();
        var footerHtml = '';
        if (stLower === "identified") {
          footerHtml += '<button class="btn btn-orange" data-modal-action="acknowledged" data-modal-id="' + esc(id) + '">Acknowledge</button>';
          footerHtml += '<button class="btn btn-blue" data-modal-action="investigating" data-modal-id="' + esc(id) + '">Investigate</button>';
        }
        if (stLower === "acknowledged") {
          footerHtml += '<button class="btn btn-blue" data-modal-action="investigating" data-modal-id="' + esc(id) + '">Investigate</button>';
        }
        if (stLower === "investigating") {
          footerHtml += '<button class="btn btn-green" data-modal-action="mitigated" data-modal-id="' + esc(id) + '">Mitigate</button>';
        }
        if (stLower !== "resolved") {
          footerHtml += '<button class="btn btn-green" data-modal-action="resolved" data-modal-id="' + esc(id) + '">Resolve</button>';
        }
        footerEl.innerHTML = footerHtml;

        /* Footer event delegation */
        footerEl.onclick = function(e) {
          var btn = e.target.closest("[data-modal-action]");
          if (!btn) return;
          var newState = btn.getAttribute("data-modal-action");
          var incId = btn.getAttribute("data-modal-id");
          patchIncidentState(incId, newState);
          closeModal();
        };
      }

      /* ================================================================= */
      /* ERROR LOGS                                                        */
      /* ================================================================= */
      function fetchErrorLogs() {
        var body = JSON.stringify({
          size: 50,
          sort: [{"@timestamp": {"order": "desc"}}],
          query: {
            bool: {
              should: [
                { term: { "level.keyword": "ERROR" } },
                { term: { "level.keyword": "FATAL" } }
              ],
              minimum_should_match: 1
            }
          }
        });
        safeFetch("/api/opensearch/logclaw-logs-*/_search", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: body
        })
        .then(function(d) {
          var hits = (d.hits && d.hits.hits) || [];
          var el = document.getElementById("errorBody");
          if (hits.length === 0) {
            el.innerHTML = '<tr><td colspan="5" class="table-empty">No errors found</td></tr>';
            return;
          }
          var html = "";
          hits.forEach(function(h) {
            var s = h._source || {};
            html += '<tr>' +
              '<td class="mono">' + esc(relTime(s["@timestamp"] || s.timestamp)) + '</td>' +
              '<td>' + levelBadge(s.level) + '</td>' +
              '<td>' + esc(s.service || "--") + '</td>' +
              '<td class="truncate">' + esc(s.message || "--") + '</td>' +
              '<td class="mono">' + esc(s.trace_id || s.traceId || "--") + '</td></tr>';
          });
          el.innerHTML = html;
        })
        .catch(function(e) {
          document.getElementById("errorBody").innerHTML =
            '<tr><td colspan="5" class="error-msg">Failed to load: ' + esc(e.message) + '</td></tr>';
        });
      }

      /* ================================================================= */
      /* LOG STREAM                                                        */
      /* ================================================================= */
      function fetchLogStream() {
        var body = JSON.stringify({
          size: 100,
          sort: [{"@timestamp": {"order": "desc"}}],
          query: { match_all: {} }
        });
        safeFetch("/api/opensearch/logclaw-logs-*/_search", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: body
        })
        .then(function(d) {
          var hits = (d.hits && d.hits.hits) || [];
          state.allLogHits = hits;
          renderLogStream(hits);
        })
        .catch(function(e) {
          document.getElementById("logBody").innerHTML =
            '<tr><td colspan="5" class="error-msg">Failed to load: ' + esc(e.message) + '</td></tr>';
        });
      }

      function renderLogStream(hits) {
        var el = document.getElementById("logBody");
        if (hits.length === 0) {
          el.innerHTML = '<tr><td colspan="5" class="table-empty">No logs</td></tr>';
          return;
        }
        var filterText = (document.getElementById("logSearchInput").value || "").toLowerCase().trim();
        var filtered = hits;
        if (filterText) {
          filtered = hits.filter(function(h) {
            var s = h._source || {};
            var combined = (s.message || "") + " " + (s.service || "") + " " + (s.level || "") + " " + (s.host || s.hostname || "");
            return combined.toLowerCase().indexOf(filterText) !== -1;
          });
        }
        if (filtered.length === 0) {
          el.innerHTML = '<tr><td colspan="5" class="table-empty">No matching logs</td></tr>';
          return;
        }
        var html = "";
        filtered.forEach(function(h) {
          var s = h._source || {};
          html += '<tr>' +
            '<td class="mono">' + esc(relTime(s["@timestamp"] || s.timestamp)) + '</td>' +
            '<td>' + levelBadge(s.level) + '</td>' +
            '<td>' + esc(s.service || "--") + '</td>' +
            '<td>' + esc(s.host || s.hostname || "--") + '</td>' +
            '<td class="truncate">' + esc(s.message || "--") + '</td></tr>';
        });
        el.innerHTML = html;
      }

      function setupLogSearch() {
        var input = document.getElementById("logSearchInput");
        var timer;
        input.addEventListener("input", function() {
          clearTimeout(timer);
          timer = setTimeout(function() {
            renderLogStream(state.allLogHits);
          }, 200);
        });
      }

      /* ================================================================= */
      /* INTEGRATIONS                                                      */
      /* ================================================================= */
      var INTEGRATION_DEFS = [
        { key: "jira", name: "Jira", icon: "&#127919;", desc: "Issue tracking and project management" },
        { key: "servicenow", name: "ServiceNow", icon: "&#128221;", desc: "IT service management" },
        { key: "pagerduty", name: "PagerDuty", icon: "&#128276;", desc: "On-call alerting and escalation" },
        { key: "opsgenie", name: "OpsGenie", icon: "&#128225;", desc: "Alert management and routing" },
        { key: "slack", name: "Slack", icon: "&#128172;", desc: "Team messaging and notifications" }
      ];

      function fetchIntegrations() {
        safeFetch("/api/ticketing/api/integrations")
          .then(function(d) {
            renderIntegrations(d);
          })
          .catch(function() {
            renderIntegrations({});
          });
      }

      function renderIntegrations(data) {
        var el = document.getElementById("integrationGrid");
        var integrations = data.integrations || data;
        var html = "";
        INTEGRATION_DEFS.forEach(function(def) {
          var info = integrations[def.key] || {};
          var connected = info.enabled === true || info.connected === true || info.status === "connected";
          html += '<div class="integration-card">';
          html += '<div class="integration-icon">' + def.icon + '</div>';
          html += '<div class="integration-info">';
          html += '<div class="integration-name">' + esc(def.name) + '</div>';
          html += '<div class="integration-desc">' + esc(def.desc) + '</div>';
          html += '</div>';
          html += '<span class="integration-status ' + (connected ? 'connected' : 'disconnected') + '">';
          html += connected ? 'Connected' : 'Disconnected';
          html += '</span></div>';
        });
        el.innerHTML = html;
      }

      /* ================================================================= */
      /* FILE UPLOAD / DRAG & DROP                                         */
      /* ================================================================= */
      function setupDropZone() {
        var zone = document.getElementById("dropZone");
        var input = document.getElementById("fileInput");

        zone.addEventListener("click", function() { input.click(); });
        input.addEventListener("change", function() {
          if (input.files.length > 0) handleFiles(input.files);
        });

        zone.addEventListener("dragover", function(e) {
          e.preventDefault();
          zone.classList.add("drag-over");
        });
        zone.addEventListener("dragleave", function() {
          zone.classList.remove("drag-over");
        });
        zone.addEventListener("drop", function(e) {
          e.preventDefault();
          zone.classList.remove("drag-over");
          if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
        });
      }

      function handleFiles(fileList) {
        var progressContainer = document.getElementById("uploadProgress");
        var progressBar = document.getElementById("uploadProgressBar");
        var statusEl = document.getElementById("uploadStatus");

        progressContainer.style.display = "block";
        statusEl.style.display = "block";
        progressBar.style.width = "0%";
        statusEl.textContent = "Parsing files...";

        var allLogs = [];
        var filesProcessed = 0;
        var totalFiles = fileList.length;

        Array.from(fileList).forEach(function(file) {
          var reader = new FileReader();
          reader.onload = function(e) {
            var text = e.target.result;
            var logs = parseLogFile(text, file.name);
            allLogs = allLogs.concat(logs);
            filesProcessed++;
            progressBar.style.width = Math.round((filesProcessed / totalFiles) * 30) + "%";
            statusEl.textContent = "Parsed " + filesProcessed + "/" + totalFiles + " files (" + allLogs.length + " entries)";
            if (filesProcessed === totalFiles) {
              uploadLogs(allLogs);
            }
          };
          reader.onerror = function() {
            filesProcessed++;
            if (filesProcessed === totalFiles && allLogs.length > 0) uploadLogs(allLogs);
          };
          reader.readAsText(file);
        });
      }

      function parseLogFile(text, filename) {
        var logs = [];
        var ext = filename.split(".").pop().toLowerCase();

        if (ext === "json") {
          try {
            var parsed = JSON.parse(text);
            if (Array.isArray(parsed)) return parsed;
            return [parsed];
          } catch(e) { /* fall through to ndjson */ }
        }

        if (ext === "ndjson" || ext === "json") {
          var lines = text.split("\n");
          lines.forEach(function(line) {
            line = line.trim();
            if (!line) return;
            try { logs.push(JSON.parse(line)); } catch(e) { /* skip */ }
          });
          if (logs.length > 0) return logs;
        }

        if (ext === "csv") {
          var csvLines = text.split("\n");
          if (csvLines.length < 2) return [];
          var headers = csvLines[0].split(",").map(function(h) { return h.trim().replace(/^"|"$/g, ""); });
          for (var i = 1; i < csvLines.length; i++) {
            var line = csvLines[i].trim();
            if (!line) continue;
            var vals = line.split(",").map(function(v) { return v.trim().replace(/^"|"$/g, ""); });
            var obj = {};
            headers.forEach(function(h, idx) { obj[h] = vals[idx] || ""; });
            if (!obj["@timestamp"] && !obj.timestamp) obj["@timestamp"] = new Date().toISOString();
            logs.push(obj);
          }
          return logs;
        }

        /* .log / .txt  plain text lines */
        var textLines = text.split("\n");
        textLines.forEach(function(line) {
          line = line.trim();
          if (!line) return;
          var entry = { message: line, "@timestamp": new Date().toISOString(), source: filename };
          var levelMatch = line.match(/\b(FATAL|ERROR|WARN(?:ING)?|INFO|DEBUG|TRACE)\b/i);
          if (levelMatch) entry.level = levelMatch[1].toUpperCase();
          logs.push(entry);
        });
        return logs;
      }

      function uploadLogs(logs) {
        var progressBar = document.getElementById("uploadProgressBar");
        var statusEl = document.getElementById("uploadStatus");
        var batchSize = 50;
        var totalBatches = Math.ceil(logs.length / batchSize);
        var batchesSent = 0;
        var totalSent = 0;
        var errors = [];

        function sendNextBatch(idx) {
          if (idx >= logs.length) {
            progressBar.style.width = "100%";
            if (errors.length > 0) {
              statusEl.textContent = "Uploaded " + totalSent + "/" + logs.length + " logs (" + errors.length + " batch errors)";
            } else {
              statusEl.textContent = "Successfully uploaded " + totalSent + " logs";
            }
            setTimeout(function() { refreshAll(); }, 1500);
            return;
          }
          var batch = logs.slice(idx, idx + batchSize);
          fetch("/api/upload", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(batch)
          })
          .then(function(r) { return r.json(); })
          .then(function() {
            totalSent += batch.length;
            batchesSent++;
            var pct = 30 + Math.round((batchesSent / totalBatches) * 70);
            progressBar.style.width = pct + "%";
            statusEl.textContent = "Uploading... " + totalSent + "/" + logs.length;
            sendNextBatch(idx + batchSize);
          })
          .catch(function(e) {
            errors.push(e.message);
            batchesSent++;
            sendNextBatch(idx + batchSize);
          });
        }

        statusEl.textContent = "Uploading " + logs.length + " logs in batches of " + batchSize + "...";
        sendNextBatch(0);
      }

      /* ================================================================= */
      /* BOOT                                                              */
      /* ================================================================= */
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }

    })();
    </script>
    </body>
    </html>
