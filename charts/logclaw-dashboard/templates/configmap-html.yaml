apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "logclaw-dashboard.fullname" . }}-html
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "logclaw-dashboard.labels" . | nindent 4 }}
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>LogClaw Dashboard</title>
      <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
      <style>
        /* ── Design Tokens ──────────────────────────────────────────────── */
        :root {
          --bg-0: #0f1117; --bg-1: #1a1d27; --bg-2: #222636; --bg-3: #2d3348;
          --border: #2d3348; --border-light: #3d4560;
          --text: #e4e7ef; --text-muted: #8b92a8; --text-dim: #5a6178;
          --accent: #6c5ce7; --accent-light: #8577ed;
          --green: #00cec9; --red: #ff6b6b; --orange: #fdcb6e; --blue: #74b9ff;
          --green-bg: rgba(0,206,201,0.12); --red-bg: rgba(255,107,107,0.12);
          --orange-bg: rgba(253,203,110,0.12); --blue-bg: rgba(116,185,255,0.12);
          --accent-bg: rgba(108,92,231,0.12);
          --radius: 8px; --radius-lg: 12px;
          --shadow: 0 2px 8px rgba(0,0,0,0.3);
          --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 14px; }
        body { font-family: var(--font); background: var(--bg-0); color: var(--text); line-height: 1.5; min-height: 100vh; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-0); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        a { color: var(--accent-light); text-decoration: none; }
        a:hover { text-decoration: underline; }
        code, pre { font-family: var(--mono); }

        /* ── Layout ─────────────────────────────────────────────────────── */
        .container { max-width: 1440px; margin: 0 auto; padding: 0 24px 48px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        @media (max-width: 1200px) { .grid-5 { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; } .gap-3 { gap: 12px; } .gap-4 { gap: 16px; } .gap-5 { gap: 20px; }
        .mt-4 { margin-top: 16px; } .mt-5 { margin-top: 20px; } .mb-3 { margin-bottom: 12px; }

        /* ── Header ─────────────────────────────────────────────────────── */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; border-bottom: 1px solid var(--border); background: var(--bg-1); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; background: linear-gradient(135deg, var(--accent), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .badge { padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; border: 1px solid; display: inline-flex; align-items: center; gap: 4px; }
        .badge-purple { background: var(--accent-bg); color: var(--accent-light); border-color: rgba(108,92,231,0.3); }
        .badge-green { background: var(--green-bg); color: var(--green); border-color: rgba(0,206,201,0.3); }
        .badge-red { background: var(--red-bg); color: var(--red); border-color: rgba(255,107,107,0.3); }
        .badge-orange { background: var(--orange-bg); color: var(--orange); border-color: rgba(253,203,110,0.3); }
        .badge-blue { background: var(--blue-bg); color: var(--blue); border-color: rgba(116,185,255,0.3); }
        .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ── Navigation ─────────────────────────────────────────────────── */
        .nav { display: flex; gap: 0; border-bottom: 1px solid var(--border); background: var(--bg-1); padding: 0 24px; }
        .nav-item { padding: 10px 20px; font-size: 0.85rem; font-weight: 500; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; }
        .nav-item:hover { color: var(--text); background: var(--bg-2); }
        .nav-item.active { color: var(--accent-light); border-bottom-color: var(--accent); }

        /* ── Cards & Panels ─────────────────────────────────────────────── */
        .card { background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; }
        .card-header { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .stat-value { font-size: 2rem; font-weight: 700; line-height: 1.1; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

        /* ── Buttons ────────────────────────────────────────────────────── */
        .btn { padding: 6px 14px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg-1); color: var(--text); cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.15s; }
        .btn:hover { border-color: var(--accent); background: var(--bg-2); }
        .btn-accent { background: var(--accent); border-color: var(--accent); color: #fff; }
        .btn-accent:hover { background: var(--accent-light); }
        .btn-sm { padding: 3px 10px; font-size: 0.7rem; }
        .btn-green { background: var(--green-bg); border-color: var(--green); color: var(--green); }
        .btn-red { background: var(--red-bg); border-color: var(--red); color: var(--red); }
        .btn-orange { background: var(--orange-bg); border-color: var(--orange); color: var(--orange); }

        /* ── Tables ─────────────────────────────────────────────────────── */
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 8px 12px; color: var(--text-muted); font-weight: 600; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        td { padding: 8px 12px; border-bottom: 1px solid var(--bg-3); vertical-align: top; }
        tr:hover td { background: var(--bg-2); }

        /* ── Forms ──────────────────────────────────────────────────────── */
        .input { padding: 6px 12px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg-2); color: var(--text); font-size: 0.8rem; outline: none; }
        .input:focus { border-color: var(--accent); }
        select.input { cursor: pointer; }

        /* ── Code Block ─────────────────────────────────────────────────── */
        .code-block { background: var(--bg-0); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; font-family: var(--mono); font-size: 0.78rem; line-height: 1.6; overflow-x: auto; color: var(--green); position: relative; white-space: pre; }
        .code-block .copy-btn { position: absolute; top: 8px; right: 8px; padding: 2px 8px; font-size: 0.65rem; }

        /* ── Upload Zone ────────────────────────────────────────────────── */
        .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius-lg); padding: 32px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: var(--accent-bg); }
        .upload-icon { font-size: 2rem; margin-bottom: 8px; }
        .progress-bar { height: 4px; background: var(--bg-3); border-radius: 2px; overflow: hidden; margin-top: 12px; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; border-radius: 2px; }

        /* ── Incident Cards ─────────────────────────────────────────────── */
        .inc-card { background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; cursor: pointer; transition: all 0.15s; }
        .inc-card:hover { border-color: var(--accent); transform: translateY(-1px); }
        .inc-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; }
        .inc-meta { font-size: 0.7rem; color: var(--text-muted); }
        .sev-critical { color: #ff4757; } .sev-high { color: var(--red); } .sev-medium { color: var(--orange); } .sev-low { color: var(--blue); }
        .state-pill { padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
        .state-identified { background: var(--red-bg); color: var(--red); }
        .state-acknowledged { background: var(--orange-bg); color: var(--orange); }
        .state-investigating { background: var(--blue-bg); color: var(--blue); }
        .state-mitigated { background: var(--accent-bg); color: var(--accent-light); }
        .state-resolved { background: var(--green-bg); color: var(--green); }

        /* ── Modal ──────────────────────────────────────────────────────── */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: flex; align-items: center; justify-content: center; }
        .modal { background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--radius-lg); width: 700px; max-width: 95vw; max-height: 85vh; overflow-y: auto; padding: 24px; }
        .modal h2 { font-size: 1.1rem; margin-bottom: 16px; }

        /* ── Pipeline Flow ──────────────────────────────────────────────── */
        .flow { display: flex; align-items: center; gap: 8px; overflow-x: auto; padding: 12px 0; }
        .flow-node { background: var(--bg-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 16px; text-align: center; min-width: 90px; font-size: 0.75rem; flex-shrink: 0; }
        .flow-node.active { border-color: var(--green); }
        .flow-arrow { color: var(--text-dim); font-size: 1.2rem; flex-shrink: 0; }
        .flow-count { font-size: 1.1rem; font-weight: 700; display: block; }

        /* ── Severity bar (for scores) ──────────────────────────────────── */
        .score-bar { height: 6px; background: var(--bg-3); border-radius: 3px; overflow: hidden; width: 80px; }
        .score-fill { height: 100%; border-radius: 3px; }

        /* ── Chart bars ─────────────────────────────────────────────────── */
        .bar-chart { display: flex; flex-direction: column; gap: 8px; }
        .bar-row { display: flex; align-items: center; gap: 10px; font-size: 0.78rem; }
        .bar-label { width: 80px; text-align: right; color: var(--text-muted); flex-shrink: 0; }
        .bar-track { flex: 1; height: 20px; background: var(--bg-3); border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; display: flex; align-items: center; padding-left: 8px; font-size: 0.7rem; font-weight: 600; color: #fff; }
        .bar-value { width: 50px; text-align: right; font-weight: 600; flex-shrink: 0; }

        /* ── Utility ────────────────────────────────────────────────────── */
        .hidden { display: none !important; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .text-center { text-align: center; }
      </style>
    </head>
    <body x-data="dashboard()" x-init="init()">
      <!-- ─── Header ───────────────────────────────────────────────────── -->
      <header class="header">
        <div class="flex items-center gap-4">
          <span class="logo">LogClaw</span>
          <span class="badge badge-purple">dev-local</span>
          <span class="badge badge-green"><span class="live-dot"></span> Live</span>
        </div>
        <div class="flex items-center gap-3">
          <span style="font-size:0.75rem;color:var(--text-muted)" x-text="'v' + apiVersion"></span>
          <button class="btn btn-sm" x-on:click="refreshAll()">Refresh</button>
          <button class="btn btn-sm" x-bind:class="autoRefresh ? 'btn-green' : ''" x-on:click="autoRefresh = !autoRefresh">
            <span x-text="autoRefresh ? 'Auto: ON' : 'Auto: OFF'"></span>
          </button>
        </div>
      </header>

      <!-- ─── Navigation ───────────────────────────────────────────────── -->
      <nav class="nav" role="tablist">
        <template x-for="t in tabs" :key="t.id">
          <div class="nav-item" role="tab"
               x-bind:class="tab === t.id ? 'active' : ''"
               x-bind:aria-selected="tab === t.id"
               x-on:click="switchTab(t.id)"
               x-text="t.label"></div>
        </template>
      </nav>

      <div class="container mt-4">

        <!-- ═══ TAB: Overview ═══════════════════════════════════════════ -->
        <div x-show="tab === 'overview'" role="tabpanel">
          <!-- Stats Row -->
          <div class="grid-5 mb-3">
            <div class="card text-center">
              <div class="stat-value" x-text="fmt(overview.totalLogs)">-</div>
              <div class="stat-label">Total Logs</div>
            </div>
            <div class="card text-center">
              <div class="stat-value" style="color:var(--blue)" x-text="overview.services">-</div>
              <div class="stat-label">Services</div>
            </div>
            <div class="card text-center">
              <div class="stat-value" style="color:var(--red)" x-text="overview.errorRate + '%'">-</div>
              <div class="stat-label">Error Rate</div>
            </div>
            <div class="card text-center">
              <div class="stat-value" style="color:var(--orange)" x-text="fmt(overview.anomalies)">-</div>
              <div class="stat-label">Anomalies</div>
            </div>
            <div class="card text-center">
              <div class="stat-value" style="color:var(--accent-light)" x-text="overview.activeIncidents">-</div>
              <div class="stat-label">Active Incidents</div>
            </div>
          </div>

          <!-- Pipeline Flow -->
          <div class="card mb-3">
            <div class="card-header">Pipeline Flow</div>
            <div class="flow">
              <template x-for="(node, i) in pipeline" :key="node.name">
                <template x-if="true">
                  <div class="flex items-center gap-2" style="display:contents">
                    <div class="flow-node" x-bind:class="node.healthy ? 'active' : ''">
                      <span class="flow-count" x-text="fmt(node.count)"></span>
                      <span x-text="node.name"></span>
                    </div>
                    <div class="flow-arrow" x-show="i < pipeline.length - 1">&rarr;</div>
                  </div>
                </template>
              </template>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="grid-2">
            <div class="card">
              <div class="card-header">Log Level Distribution</div>
              <div class="bar-chart" id="level-chart"></div>
            </div>
            <div class="card">
              <div class="card-header">Top Services</div>
              <div class="bar-chart" id="service-chart"></div>
            </div>
          </div>
        </div>

        <!-- ═══ TAB: Incidents ═════════════════════════════════════════ -->
        <div x-show="tab === 'incidents'" role="tabpanel">
          <!-- Summary Bar -->
          <div class="grid-5 mb-3" style="grid-template-columns: repeat(6, 1fr);">
            <template x-for="s in incStates" :key="s.key">
              <div class="card text-center" style="padding:12px;cursor:pointer"
                   x-bind:style="incFilter.state === s.key ? 'border-color:var(--accent)' : ''"
                   x-on:click="incFilter.state = incFilter.state === s.key ? '' : s.key; loadIncidents()">
                <div class="stat-value" style="font-size:1.5rem" x-text="incSummary[s.key] || 0"></div>
                <div class="stat-label" x-text="s.label"></div>
              </div>
            </template>
          </div>

          <!-- MTTR Metrics -->
          <div class="card mb-3" x-show="mttr.mttr">
            <div class="card-header">Resolution Metrics (Last 30 Days)</div>
            <div class="grid-3">
              <div class="text-center">
                <div class="stat-value" style="font-size:1.3rem;color:var(--green)" x-text="mttr.mttr ? mttr.mttr.avg_minutes + 'm' : '-'"></div>
                <div class="stat-label">MTTR (Avg)</div>
              </div>
              <div class="text-center">
                <div class="stat-value" style="font-size:1.3rem;color:var(--orange)" x-text="mttr.mtta ? mttr.mtta.avg_minutes + 'm' : '-'"></div>
                <div class="stat-label">MTTA (Avg)</div>
              </div>
              <div class="text-center">
                <div class="stat-value" style="font-size:1.3rem;color:var(--blue)" x-text="mttr.mttm ? mttr.mttm.avg_minutes + 'm' : '-'"></div>
                <div class="stat-label">MTTM (Avg)</div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="flex items-center gap-3 mb-3" style="flex-wrap:wrap">
            <select class="input" x-model="incFilter.severity" x-on:change="loadIncidents()">
              <option value="">All Severities</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <select class="input" x-model="incFilter.service" x-on:change="loadIncidents()">
              <option value="">All Services</option>
              <template x-for="s in incServices" :key="s">
                <option x-bind:value="s" x-text="s"></option>
              </template>
            </select>
            <input class="input" style="width:200px" placeholder="Search incidents..." x-model="incFilter.q" x-on:input.debounce.300ms="loadIncidents()">
            <button class="btn btn-accent btn-sm" x-on:click="showCreateModal = true">+ Create Incident</button>
          </div>

          <!-- Incident List -->
          <div class="flex flex-col gap-3">
            <template x-for="inc in incidents" :key="inc.id">
              <div class="inc-card" x-on:click="openIncident(inc.id)">
                <div class="flex justify-between items-center mb-3">
                  <div class="flex items-center gap-2">
                    <span class="badge" x-bind:class="'badge-' + sevColor(inc.severity)" x-text="inc.severity" style="text-transform:uppercase;font-size:0.6rem"></span>
                    <span class="state-pill" x-bind:class="'state-' + inc.state" x-text="inc.state"></span>
                    <span style="font-size:0.7rem;color:var(--text-dim)" x-text="inc.priority || ''"></span>
                  </div>
                  <span class="inc-meta" x-text="inc.id"></span>
                </div>
                <div class="inc-title truncate" x-text="inc.title"></div>
                <div class="flex justify-between items-center mt-4" style="margin-top:8px">
                  <span class="inc-meta" x-text="'Service: ' + inc.service"></span>
                  <span class="inc-meta" x-text="timeAgo(inc.created_at)"></span>
                </div>
                <div class="flex gap-2 mt-4" style="margin-top:8px" x-on:click.stop>
                  <template x-for="action in getActions(inc)" :key="action.state">
                    <button class="btn btn-sm" x-bind:class="action.cls" x-text="action.label"
                            x-on:click="patchState(inc.id, action.state)"></button>
                  </template>
                </div>
              </div>
            </template>
            <div x-show="incidents.length === 0" class="card text-center" style="padding:40px;color:var(--text-muted)">
              No incidents found
            </div>
          </div>
          <div class="flex justify-between items-center mt-5" x-show="incPagination.total > 0">
            <span style="font-size:0.75rem;color:var(--text-muted)" x-text="'Showing ' + incidents.length + ' of ' + incPagination.total"></span>
            <div class="flex gap-2">
              <button class="btn btn-sm" x-bind:disabled="incPagination.offset === 0" x-on:click="incPagination.offset -= incPagination.limit; loadIncidents()">Prev</button>
              <button class="btn btn-sm" x-bind:disabled="!incPagination.has_more" x-on:click="incPagination.offset += incPagination.limit; loadIncidents()">Next</button>
            </div>
          </div>
        </div>

        <!-- ═══ TAB: Logs ══════════════════════════════════════════════ -->
        <div x-show="tab === 'logs'" role="tabpanel">
          <div class="flex items-center gap-3 mb-3">
            <select class="input" x-model="logFilter.level" x-on:change="loadLogs()">
              <option value="">All Levels</option>
              <option value="FATAL">FATAL</option>
              <option value="ERROR">ERROR</option>
              <option value="WARN">WARN</option>
              <option value="INFO">INFO</option>
              <option value="DEBUG">DEBUG</option>
            </select>
            <input class="input" style="width:200px" placeholder="Filter logs..." x-model="logFilter.q" x-on:input.debounce.300ms="loadLogs()">
            <span style="font-size:0.75rem;color:var(--text-muted)" x-text="'Total: ' + fmt(logTotal)"></span>
          </div>
          <div class="card" style="overflow-x:auto;padding:0">
            <table>
              <thead><tr><th style="width:130px">Time</th><th style="width:60px">Level</th><th style="width:120px">Service</th><th style="width:100px">Host</th><th>Message</th></tr></thead>
              <tbody>
                <template x-for="log in logs" :key="log._id || Math.random()">
                  <tr>
                    <td style="font-family:var(--mono);font-size:0.7rem;color:var(--text-dim)" x-text="fmtTime(log.timestamp)"></td>
                    <td><span class="badge" x-bind:class="levelClass(log.level)" x-text="log.level" style="font-size:0.6rem"></span></td>
                    <td class="truncate" style="max-width:120px" x-text="log.service"></td>
                    <td class="truncate" style="max-width:100px;color:var(--text-muted)" x-text="log.host || '-'"></td>
                    <td style="font-family:var(--mono);font-size:0.75rem" x-text="log.message"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ═══ TAB: Ingestion ═════════════════════════════════════════ -->
        <div x-show="tab === 'ingestion'" role="tabpanel">
          <div class="grid-2">
            <!-- Left: Upload Zone -->
            <div>
              <div class="card mb-3">
                <div class="card-header">Drag &amp; Drop Upload</div>
                <div class="upload-zone" id="upload-zone"
                     x-on:dragover.prevent="$el.classList.add('dragover')"
                     x-on:dragleave="$el.classList.remove('dragover')"
                     x-on:drop.prevent="handleDrop($event)"
                     x-on:click="$refs.fileInput.click()">
                  <div class="upload-icon">&#128230;</div>
                  <div style="font-weight:600">Drop log files here or click to browse</div>
                  <div style="color:var(--text-muted);font-size:0.75rem;margin-top:4px">.json, .ndjson, .log, .csv, .txt</div>
                  <input type="file" x-ref="fileInput" style="display:none" multiple accept=".json,.ndjson,.log,.csv,.txt" x-on:change="handleFiles($event.target.files)">
                </div>
                <div class="progress-bar mt-4" x-show="uploadProgress > 0">
                  <div class="progress-fill" x-bind:style="'width:' + uploadProgress + '%'"></div>
                </div>
                <div style="font-size:0.75rem;margin-top:8px;color:var(--text-muted)" x-text="uploadStatus"></div>
              </div>

              <!-- Quick Send -->
              <div class="card">
                <div class="card-header">Quick JSON Upload</div>
                <textarea class="input" style="width:100%;height:120px;font-family:var(--mono);font-size:0.75rem;resize:vertical" x-model="quickJson" placeholder='[{"level": "ERROR", "service": "api-gw", "message": "Connection refused"}]'></textarea>
                <button class="btn btn-accent mt-4" style="margin-top:10px" x-on:click="sendQuickJson()">Send Logs</button>
              </div>
            </div>

            <!-- Right: API Documentation -->
            <div>
              <div class="card mb-3">
                <div class="card-header">Log Ingestion API</div>
                <p style="color:var(--text-muted);font-size:0.8rem;margin-bottom:12px">Send logs via HTTP POST. Logs flow through the full pipeline: Vector &rarr; Kafka &rarr; Bridge &rarr; OpenSearch.</p>

                <div style="font-weight:600;font-size:0.8rem;margin-bottom:6px">Endpoint</div>
                <div class="code-block" style="margin-bottom:16px" x-text="'POST /api/upload\nContent-Type: application/json'"></div>

                <div style="font-weight:600;font-size:0.8rem;margin-bottom:6px">cURL Example</div>
                <div class="code-block" style="margin-bottom:16px" x-text="curlExample"></div>

                <div style="font-weight:600;font-size:0.8rem;margin-bottom:6px">Log Schema</div>
                <div class="code-block" x-text="logSchema"></div>
              </div>

              <div class="card">
                <div class="card-header">Pipeline Endpoints</div>
                <table style="font-size:0.75rem">
                  <tbody>
                    <tr><td style="font-weight:600">Upload (proxy)</td><td><code>POST /api/upload</code></td></tr>
                    <tr><td style="font-weight:600">Vector (direct)</td><td><code>POST /api/vector/</code></td></tr>
                    <tr><td style="font-weight:600">OpenSearch</td><td><code>GET /api/opensearch/logclaw-logs-*/_search</code></td></tr>
                    <tr><td style="font-weight:600">Bridge Health</td><td><code>GET /api/bridge/health</code></td></tr>
                    <tr><td style="font-weight:600">Bridge Metrics</td><td><code>GET /api/bridge/metrics</code></td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ TAB: Settings ═════════════════════════════════════════ -->
        <div x-show="tab === 'settings'" role="tabpanel">
          <div class="grid-2">
            <!-- Integrations -->
            <div class="card">
              <div class="card-header">Integrations</div>
              <template x-for="(cfg, name) in integrations" :key="name">
                <div class="flex justify-between items-center" style="padding:10px 0;border-bottom:1px solid var(--bg-3)">
                  <div>
                    <span style="font-weight:600;text-transform:capitalize" x-text="name"></span>
                    <span style="font-size:0.7rem;color:var(--text-muted);margin-left:8px" x-text="cfg.url || cfg.channel || cfg.api_url || ''"></span>
                  </div>
                  <span class="badge" x-bind:class="cfg.enabled ? 'badge-green' : 'badge-red'" x-text="cfg.enabled ? 'Connected' : 'Disabled'"></span>
                </div>
              </template>
            </div>

            <!-- API Schema -->
            <div class="card">
              <div class="card-header">Incident API (v1)</div>
              <div style="max-height:400px;overflow-y:auto">
                <template x-for="ep in apiEndpoints" :key="ep.path">
                  <div style="padding:6px 0;border-bottom:1px solid var(--bg-3);font-size:0.75rem">
                    <span class="badge" x-bind:class="ep.method === 'GET' ? 'badge-green' : ep.method === 'POST' ? 'badge-blue' : ep.method === 'PATCH' ? 'badge-orange' : 'badge-red'" x-text="ep.method" style="font-size:0.6rem;min-width:50px;justify-content:center"></span>
                    <code style="margin-left:8px" x-text="ep.path"></code>
                    <div style="color:var(--text-muted);font-size:0.7rem;margin-top:2px;padding-left:60px" x-text="ep.description"></div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Health -->
          <div class="card mt-5">
            <div class="card-header">System Health</div>
            <div class="code-block" x-text="JSON.stringify(health, null, 2)"></div>
          </div>
        </div>

      </div>

      <!-- ─── Incident Detail Modal ────────────────────────────────────── -->
      <div class="modal-overlay" x-show="selectedInc" x-on:click.self="selectedInc = null" x-on:keydown.escape.window="selectedInc = null" x-cloak>
        <div class="modal" x-show="selectedInc">
          <template x-if="selectedInc">
            <div>
              <div class="flex justify-between items-center mb-3">
                <h2 x-text="selectedInc.id + ' — ' + selectedInc.title"></h2>
                <button class="btn btn-sm" x-on:click="selectedInc = null">Close</button>
              </div>
              <div class="grid-3 mb-3" style="gap:10px">
                <div><span style="color:var(--text-muted);font-size:0.7rem">Severity</span><br><span class="badge" x-bind:class="'badge-' + sevColor(selectedInc.severity)" x-text="selectedInc.severity" style="text-transform:uppercase"></span></div>
                <div><span style="color:var(--text-muted);font-size:0.7rem">Priority</span><br><span style="font-weight:700" x-text="selectedInc.priority || '-'"></span></div>
                <div><span style="color:var(--text-muted);font-size:0.7rem">State</span><br><span class="state-pill" x-bind:class="'state-' + selectedInc.state" x-text="selectedInc.state"></span></div>
                <div><span style="color:var(--text-muted);font-size:0.7rem">Service</span><br><span x-text="selectedInc.service"></span></div>
                <div><span style="color:var(--text-muted);font-size:0.7rem">Commander</span><br><span x-text="selectedInc.commander || 'Unassigned'"></span></div>
                <div><span style="color:var(--text-muted);font-size:0.7rem">Correlation</span><br><code style="font-size:0.7rem" x-text="selectedInc.correlation_id || '-'"></code></div>
              </div>
              <div style="margin-bottom:12px" x-show="selectedInc.description">
                <span style="color:var(--text-muted);font-size:0.7rem">Description</span>
                <p style="font-size:0.8rem;margin-top:4px" x-text="selectedInc.description"></p>
              </div>
              <div style="margin-bottom:12px" x-show="selectedInc.impact">
                <span style="color:var(--text-muted);font-size:0.7rem">Impact</span>
                <p style="font-size:0.8rem;margin-top:4px" x-text="selectedInc.impact || 'Not assessed'"></p>
              </div>

              <!-- Milestones -->
              <div class="card-header" style="margin-top:16px">Milestones</div>
              <div class="grid-2" style="gap:8px;margin-bottom:16px;font-size:0.75rem">
                <div>Detected: <span style="color:var(--green)" x-text="selectedInc.detected_at ? fmtTime(selectedInc.detected_at) : '-'"></span></div>
                <div>Acknowledged: <span style="color:var(--orange)" x-text="selectedInc.acknowledged_at ? fmtTime(selectedInc.acknowledged_at) : '-'"></span></div>
                <div>Mitigated: <span style="color:var(--blue)" x-text="selectedInc.mitigated_at ? fmtTime(selectedInc.mitigated_at) : '-'"></span></div>
                <div>Resolved: <span style="color:var(--accent-light)" x-text="selectedInc.resolved_at ? fmtTime(selectedInc.resolved_at) : '-'"></span></div>
              </div>

              <!-- Timeline -->
              <div class="card-header">Timeline</div>
              <div style="max-height:200px;overflow-y:auto;margin-bottom:16px">
                <template x-for="ev in (selectedInc.timeline || [])" :key="ev.id || ev.timestamp">
                  <div style="padding:6px 0;border-bottom:1px solid var(--bg-3);font-size:0.75rem">
                    <span style="color:var(--text-dim)" x-text="fmtTime(ev.timestamp)"></span>
                    <span class="state-pill" x-bind:class="'state-' + ev.state" x-text="ev.state" style="margin:0 6px"></span>
                    <span x-text="ev.message"></span>
                    <span style="color:var(--text-dim);margin-left:6px" x-text="'by ' + ev.actor"></span>
                  </div>
                </template>
              </div>

              <!-- Actions -->
              <div class="flex gap-2">
                <template x-for="action in getActions(selectedInc)" :key="action.state">
                  <button class="btn" x-bind:class="action.cls" x-text="action.label"
                          x-on:click="patchState(selectedInc.id, action.state); openIncident(selectedInc.id)"></button>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- ─── Create Incident Modal ────────────────────────────────────── -->
      <div class="modal-overlay" x-show="showCreateModal" x-on:click.self="showCreateModal = false" x-cloak>
        <div class="modal" style="width:500px">
          <h2 style="margin-bottom:16px">Create Incident</h2>
          <div class="flex flex-col gap-3">
            <input class="input" placeholder="Title" x-model="newInc.title">
            <textarea class="input" style="height:80px;resize:vertical" placeholder="Description" x-model="newInc.description"></textarea>
            <div class="grid-2" style="gap:10px">
              <select class="input" x-model="newInc.severity"><option value="critical">Critical</option><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select>
              <input class="input" placeholder="Service" x-model="newInc.service">
            </div>
            <input class="input" placeholder="Impact description" x-model="newInc.impact">
            <input class="input" placeholder="Commander" x-model="newInc.commander">
          </div>
          <div class="flex gap-2 mt-5" style="margin-top:16px">
            <button class="btn btn-accent" x-on:click="createIncident()">Create</button>
            <button class="btn" x-on:click="showCreateModal = false">Cancel</button>
          </div>
        </div>
      </div>

      <script>
      function dashboard() {
        return {
          tab: "overview",
          tabs: [
            {id: "overview", label: "Overview"},
            {id: "incidents", label: "Incidents"},
            {id: "logs", label: "Logs"},
            {id: "ingestion", label: "Ingestion"},
            {id: "settings", label: "Settings"}
          ],
          autoRefresh: true,
          apiVersion: "",
          health: {},

          // Overview
          overview: {totalLogs: 0, services: 0, errorRate: "0.0", anomalies: 0, activeIncidents: 0},
          pipeline: [
            {name: "Sources", count: 0, healthy: true},
            {name: "Vector", count: 0, healthy: true},
            {name: "Kafka", count: 0, healthy: true},
            {name: "Bridge", count: 0, healthy: true},
            {name: "OpenSearch", count: 0, healthy: true},
            {name: "Incidents", count: 0, healthy: true}
          ],

          // Incidents
          incidents: [],
          incPagination: {total: 0, limit: 20, offset: 0, has_more: false},
          incFilter: {state: "", severity: "", service: "", q: ""},
          incStates: [
            {key: "", label: "All"},
            {key: "identified", label: "Identified"},
            {key: "acknowledged", label: "Acknowledged"},
            {key: "investigating", label: "Investigating"},
            {key: "mitigated", label: "Mitigated"},
            {key: "resolved", label: "Resolved"}
          ],
          incSummary: {},
          incServices: [],
          selectedInc: null,
          showCreateModal: false,
          newInc: {title: "", description: "", severity: "medium", service: "", impact: "", commander: ""},
          mttr: {},

          // Logs
          logs: [], logTotal: 0,
          logFilter: {level: "", q: ""},

          // Ingestion
          uploadProgress: 0, uploadStatus: "",
          quickJson: "",
          curlExample: 'curl -X POST http://localhost:3333/api/upload \\\n  -H "Content-Type: application/json" \\\n  -d \'[{\n    "timestamp": "2026-03-01T12:00:00Z",\n    "level": "ERROR",\n    "service": "api-gateway",\n    "message": "Connection refused",\n    "host": "pod-1",\n    "trace_id": "abc-123"\n  }]\'',
          logSchema: '{\n  "timestamp": "ISO 8601 (required)",\n  "level": "FATAL|ERROR|WARN|INFO|DEBUG",\n  "service": "originating service name",\n  "message": "log message text",\n  "host": "hostname or pod name",\n  "trace_id": "distributed trace ID",\n  "endpoint": "/api/v1/resource",\n  "duration_ms": 150\n}',

          // Settings
          integrations: {},
          apiEndpoints: [],

          async init() {
            await this.refreshAll();
            this._interval = setInterval(() => { if (this.autoRefresh) this.refreshAll(); }, 10000);
          },

          switchTab(t) {
            this.tab = t;
            if (t === "incidents") this.loadIncidents();
            if (t === "logs") this.loadLogs();
            if (t === "settings") this.loadSettings();
          },

          async refreshAll() {
            this.loadOverview();
            if (this.tab === "incidents") this.loadIncidents();
            if (this.tab === "logs") this.loadLogs();
          },

          // ── Data Loading ──────────────────────────────────────────
          async safeFetch(url, opts) {
            try {
              var ctrl = new AbortController();
              var timer = setTimeout(function() { ctrl.abort(); }, 15000);
              var r = await fetch(url, Object.assign({signal: ctrl.signal}, opts || {}));
              clearTimeout(timer);
              return r.ok ? await r.json() : null;
            } catch(e) { return null; }
          },

          async loadOverview() {
            var [countData, anomData, statsData, bridgeData, healthData] = await Promise.all([
              this.safeFetch("/api/opensearch/logclaw-logs-*/_count"),
              this.safeFetch("/api/opensearch/logclaw-anomalies-*/_count"),
              this.safeFetch("/api/ticketing/api/v1/stats"),
              this.safeFetch("/api/bridge/metrics"),
              this.safeFetch("/health")
            ]);

            if (healthData) this.health = healthData;

            var totalLogs = countData ? countData.count : 0;
            var totalAnomalies = anomData ? anomData.count : 0;

            // Service count + error rate from search
            var searchData = await this.safeFetch("/api/opensearch/logclaw-logs-*/_search", {
              method: "POST", headers: {"Content-Type": "application/json"},
              body: JSON.stringify({size: 0, aggs: {
                services: {cardinality: {field: "service"}},
                levels: {terms: {field: "level", size: 10}}
              }})
            });
            var services = 0, errorRate = 0;
            if (searchData && searchData.aggregations) {
              services = searchData.aggregations.services.value || 0;
              var total = 0, errors = 0;
              (searchData.aggregations.levels.buckets || []).forEach(function(b) {
                total += b.doc_count;
                if (b.key === "ERROR" || b.key === "FATAL") errors += b.doc_count;
              });
              if (total > 0) errorRate = ((errors / total) * 100).toFixed(1);

              // Render level chart
              this.renderBarChart("level-chart", searchData.aggregations.levels.buckets, {
                FATAL: "#c0392b", ERROR: "var(--red)", WARN: "var(--orange)", INFO: "var(--blue)", DEBUG: "#636e72"
              });
            }

            // Service chart
            var svcData = await this.safeFetch("/api/opensearch/logclaw-logs-*/_search", {
              method: "POST", headers: {"Content-Type": "application/json"},
              body: JSON.stringify({size: 0, aggs: {top_svc: {terms: {field: "service", size: 8}}}})
            });
            if (svcData && svcData.aggregations) {
              var colors = ["var(--accent)", "var(--green)", "var(--blue)", "var(--orange)", "var(--red)", "#a29bfe", "#fd79a8", "#00b894"];
              this.renderBarChart("service-chart", svcData.aggregations.top_svc.buckets, null, colors);
            }

            var activeInc = statsData ? (statsData.total - (statsData.by_state.resolved || 0)) : 0;

            this.overview = {totalLogs: totalLogs, services: services, errorRate: errorRate, anomalies: totalAnomalies, activeIncidents: activeInc};

            // Parse bridge metrics
            var bridgeEtl = 0, bridgeIdx = 0;
            if (bridgeData && typeof bridgeData === "string") {
              var m = bridgeData.match(/etl_consumed_total (\d+)/);
              if (m) bridgeEtl = parseInt(m[1]);
              m = bridgeData.match(/indexer_indexed_total (\d+)/);
              if (m) bridgeIdx = parseInt(m[1]);
            }

            this.pipeline = [
              {name: "Sources", count: totalLogs, healthy: true},
              {name: "Vector", count: totalLogs, healthy: true},
              {name: "Kafka", count: bridgeEtl || totalLogs, healthy: true},
              {name: "Bridge", count: bridgeIdx || totalLogs, healthy: bridgeData !== null},
              {name: "OpenSearch", count: totalLogs, healthy: countData !== null},
              {name: "Incidents", count: activeInc, healthy: statsData !== null}
            ];
          },

          renderBarChart(id, buckets, colorMap, colorList) {
            var el = document.getElementById(id);
            if (!el || !buckets) return;
            var max = 0;
            buckets.forEach(function(b) { if (b.doc_count > max) max = b.doc_count; });
            if (max === 0) max = 1;
            var html = "";
            buckets.forEach(function(b, i) {
              var pct = ((b.doc_count / max) * 100).toFixed(0);
              var color = colorMap ? (colorMap[b.key] || "var(--accent)") : (colorList ? colorList[i % colorList.length] : "var(--accent)");
              html += '<div class="bar-row">';
              html += '<span class="bar-label">' + b.key + '</span>';
              html += '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + color + '">' + (pct > 15 ? b.doc_count : '') + '</div></div>';
              html += '<span class="bar-value">' + b.doc_count + '</span>';
              html += '</div>';
            });
            el.innerHTML = html;
          },

          async loadIncidents() {
            var params = new URLSearchParams();
            params.set("limit", this.incPagination.limit);
            params.set("offset", this.incPagination.offset);
            if (this.incFilter.state) params.set("state", this.incFilter.state);
            if (this.incFilter.severity) params.set("severity", this.incFilter.severity);
            if (this.incFilter.service) params.set("service", this.incFilter.service);
            if (this.incFilter.q) params.set("q", this.incFilter.q);

            var [data, statsData, mttrData] = await Promise.all([
              this.safeFetch("/api/ticketing/api/v1/incidents?" + params.toString()),
              this.safeFetch("/api/ticketing/api/v1/stats"),
              this.safeFetch("/api/ticketing/api/v1/metrics/mttr?days=30")
            ]);

            if (data) {
              this.incidents = data.data || data.incidents || [];
              if (data.pagination) this.incPagination = Object.assign(this.incPagination, data.pagination);
            }
            if (statsData) {
              this.incSummary = Object.assign({"": statsData.total}, statsData.by_state);
              if (statsData.by_service) this.incServices = Object.keys(statsData.by_service);
            }
            if (mttrData) this.mttr = mttrData;
          },

          async openIncident(id) {
            var data = await this.safeFetch("/api/ticketing/api/v1/incidents/" + id);
            if (data) this.selectedInc = data;
          },

          async patchState(id, state) {
            await fetch("/api/ticketing/api/v1/incidents/" + id, {
              method: "PATCH",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({state: state, actor: "operator"})
            });
            this.loadIncidents();
          },

          async createIncident() {
            await fetch("/api/ticketing/api/v1/incidents", {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify(this.newInc)
            });
            this.showCreateModal = false;
            this.newInc = {title: "", description: "", severity: "medium", service: "", impact: "", commander: ""};
            this.loadIncidents();
          },

          getActions(inc) {
            var actions = [];
            var s = inc.state;
            if (s === "identified") actions.push({state: "acknowledged", label: "Acknowledge", cls: "btn-orange"});
            if (s === "identified" || s === "acknowledged") actions.push({state: "investigating", label: "Investigate", cls: "btn-blue"});
            if (s !== "mitigated" && s !== "resolved") actions.push({state: "mitigated", label: "Mitigate", cls: "btn-accent"});
            if (s !== "resolved") actions.push({state: "resolved", label: "Resolve", cls: "btn-green"});
            return actions;
          },

          async loadLogs() {
            var musts = [];
            if (this.logFilter.level) musts.push({term: {level: this.logFilter.level}});
            if (this.logFilter.q) musts.push({multi_match: {query: this.logFilter.q, fields: ["message", "service"]}});
            var query = musts.length > 0 ? {bool: {must: musts}} : {match_all: {}};
            var data = await this.safeFetch("/api/opensearch/logclaw-logs-*/_search", {
              method: "POST", headers: {"Content-Type": "application/json"},
              body: JSON.stringify({size: 100, sort: [{"_doc": "desc"}], query: query})
            });
            if (data && data.hits) {
              this.logs = data.hits.hits.map(function(h) { return h._source; });
              this.logTotal = data.hits.total.value;
            }
          },

          async loadSettings() {
            var [intData, schemaData] = await Promise.all([
              this.safeFetch("/api/ticketing/api/v1/integrations"),
              this.safeFetch("/api/ticketing/api/v1/schema")
            ]);
            if (intData) this.integrations = intData;
            if (schemaData) {
              this.apiVersion = schemaData.version || "";
              this.apiEndpoints = schemaData.endpoints || [];
            }
          },

          // ── Upload Handling ───────────────────────────────────────
          handleDrop(event) {
            event.target.classList.remove("dragover");
            this.handleFiles(event.dataTransfer.files);
          },

          handleFiles(files) {
            if (!files || files.length === 0) return;
            var self = this;
            var allLogs = [];
            var pending = files.length;
            Array.from(files).forEach(function(file) {
              var reader = new FileReader();
              reader.onload = function(e) {
                var text = e.target.result;
                var parsed = self.parseLogFile(text, file.name);
                allLogs = allLogs.concat(parsed);
                pending--;
                if (pending === 0 && allLogs.length > 0) self.uploadLogs(allLogs);
              };
              reader.readAsText(file);
            });
          },

          parseLogFile(text, filename) {
            var ext = (filename.split(".").pop() || "").toLowerCase();
            // JSON array
            if (ext === "json") {
              try {
                var arr = JSON.parse(text);
                return Array.isArray(arr) ? arr : [arr];
              } catch(e) { return []; }
            }
            // NDJSON
            if (ext === "ndjson") {
              return text.split("\n").filter(Boolean).map(function(line) {
                try { return JSON.parse(line); } catch(e) { return null; }
              }).filter(Boolean);
            }
            // CSV
            if (ext === "csv") {
              var lines = text.split("\n").filter(Boolean);
              if (lines.length < 2) return [];
              var headers = lines[0].split(",").map(function(h) { return h.trim().replace(/"/g, ""); });
              return lines.slice(1).map(function(line) {
                var vals = line.split(",");
                var obj = {};
                headers.forEach(function(h, i) { obj[h] = (vals[i] || "").trim().replace(/"/g, ""); });
                return obj;
              });
            }
            // Plain text / log
            return text.split("\n").filter(Boolean).map(function(line) {
              var level = "INFO";
              if (/\bFATAL\b/i.test(line)) level = "FATAL";
              else if (/\bERROR\b/i.test(line)) level = "ERROR";
              else if (/\bWARN/i.test(line)) level = "WARN";
              else if (/\bDEBUG\b/i.test(line)) level = "DEBUG";
              return {timestamp: new Date().toISOString(), level: level, service: "upload", message: line};
            });
          },

          async uploadLogs(logs) {
            var self = this;
            var batchSize = 50;
            var totalBatches = Math.ceil(logs.length / batchSize);
            var sent = 0, batchesDone = 0;
            self.uploadProgress = 5;
            self.uploadStatus = "Uploading " + logs.length + " logs...";

            for (var i = 0; i < logs.length; i += batchSize) {
              var batch = logs.slice(i, i + batchSize);
              try {
                await fetch("/api/upload", {method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(batch)});
                sent += batch.length;
              } catch(e) {}
              batchesDone++;
              self.uploadProgress = 5 + Math.round((batchesDone / totalBatches) * 95);
              self.uploadStatus = "Uploading... " + sent + "/" + logs.length;
            }
            self.uploadProgress = 100;
            self.uploadStatus = "Uploaded " + sent + " logs successfully";
            setTimeout(function() { self.uploadProgress = 0; self.refreshAll(); }, 2000);
          },

          async sendQuickJson() {
            try {
              var logs = JSON.parse(this.quickJson);
              if (!Array.isArray(logs)) logs = [logs];
              await this.uploadLogs(logs);
              this.quickJson = "";
            } catch(e) {
              this.uploadStatus = "Invalid JSON: " + e.message;
            }
          },

          // ── Helpers ───────────────────────────────────────────────
          fmt(n) {
            if (n == null || isNaN(n)) return "-";
            if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
            if (n >= 1000) return (n / 1000).toFixed(1) + "K";
            return String(n);
          },
          timeAgo(iso) {
            if (!iso) return "";
            var s = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
            if (s < 60) return s + "s ago";
            if (s < 3600) return Math.floor(s / 60) + "m ago";
            if (s < 86400) return Math.floor(s / 3600) + "h ago";
            return Math.floor(s / 86400) + "d ago";
          },
          fmtTime(iso) {
            if (!iso) return "-";
            try { return new Date(iso).toLocaleTimeString(); } catch(e) { return iso; }
          },
          sevColor(sev) {
            return {critical: "red", high: "orange", medium: "orange", low: "blue"}[sev] || "purple";
          },
          levelClass(level) {
            return {FATAL: "badge-red", ERROR: "badge-red", WARN: "badge-orange", INFO: "badge-blue", DEBUG: "badge-purple"}[level] || "badge-purple";
          }
        };
      }
      </script>
    </body>
    </html>
