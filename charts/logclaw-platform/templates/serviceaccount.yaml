{{- if .Values.serviceAccount.create -}}
{{- $tenantId := include "logclaw.tenantId" . -}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "logclaw-platform.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "logclaw-platform.labels" . | nindent 4 }}
  annotations:
    logclaw.io/tenant-id: {{ $tenantId | quote }}
    logclaw.io/sa-purpose: "eso-secretstore-auth"
    {{- if eq (.Values.global.secretStore.provider | default "") "aws" }}
    # IRSA annotation — links this ServiceAccount to the AWS IAM Role
    # that grants read access to Secrets Manager for this tenant.
    eks.amazonaws.com/role-arn: {{ .Values.global.secretStore.aws.iamRoleArn | required "global.secretStore.aws.iamRoleArn is required for aws provider IRSA" | quote }}
    eks.amazonaws.com/token-expiration: "86400"
    {{- else if eq (.Values.global.secretStore.provider | default "") "gcp" }}
    # Workload Identity annotation — links this ServiceAccount to the GCP
    # Service Account that has Secret Manager secretAccessor permission.
    iam.gke.io/gcp-service-account: {{ .Values.global.secretStore.gcp.serviceAccount | required "global.secretStore.gcp.serviceAccount is required for gcp provider Workload Identity" | quote }}
    {{- else if eq (.Values.global.secretStore.provider | default "") "azure" }}
    # Azure Workload Identity annotations
    azure.workload.identity/client-id: {{ .Values.global.secretStore.azure.clientId | required "global.secretStore.azure.clientId is required for azure provider Workload Identity" | quote }}
    azure.workload.identity/tenant-id: {{ .Values.global.secretStore.azure.tenantId | required "global.secretStore.azure.tenantId is required for azure provider Workload Identity" | quote }}
    {{- end }}
    {{- with .Values.serviceAccount.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
{{- if eq (.Values.global.secretStore.provider | default "") "azure" }}
  labels:
    {{- include "logclaw-platform.labels" . | nindent 4 }}
    azure.workload.identity/use: "true"
{{- end }}
automountServiceAccountToken: false
{{- end }}
