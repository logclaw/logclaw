{{- $tenantId := include "logclaw-airflow.tenantId" . }}
---
# ExternalSecret: logclaw-airflow-credentials
# Syncs fernet key, webserver secret key, and postgresql password from the
# external secrets store into a single Kubernetes Secret used by Airflow.
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "logclaw-airflow.fullname" . }}-credentials
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "logclaw-airflow.labels" . | nindent 4 }}
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: logclaw-cluster-secret-store
    kind: ClusterSecretStore
  target:
    name: logclaw-airflow-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "logclaw-airflow.labels" . | nindent 10 }}
  data:
    - secretKey: fernet-key
      remoteRef:
        key: "logclaw/{{ $tenantId }}/airflow/fernet-key"
        property: value
    - secretKey: webserver-secret-key
      remoteRef:
        key: "logclaw/{{ $tenantId }}/airflow/webserver-secret-key"
        property: value
    - secretKey: postgresql-password
      remoteRef:
        key: "logclaw/{{ $tenantId }}/airflow/postgresql-password"
        property: value
---
# ExternalSecret: airflow-git-ssh
# Syncs the SSH private key used by the git-sync sidecar to pull DAGs.
# The key is placed under the "gitSshKey" field expected by apache-airflow
# chart's git-sync configuration.
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "logclaw-airflow.fullname" . }}-git-ssh
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "logclaw-airflow.labels" . | nindent 4 }}
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: logclaw-cluster-secret-store
    kind: ClusterSecretStore
  target:
    name: airflow-git-ssh
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "logclaw-airflow.labels" . | nindent 10 }}
  data:
    - secretKey: gitSshKey
      remoteRef:
        key: "logclaw/{{ $tenantId }}/airflow/git-ssh-key"
        property: value
