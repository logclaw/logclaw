{{- if .Values.fluentd.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "logclaw-ingestion.fullname" . }}-fluentd-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "logclaw-ingestion.labels" . | nindent 4 }}
    app.kubernetes.io/component: fluentd
data:
  fluent.conf: |
    # =========================================================================
    # Fluentd Configuration — LogClaw Ingestion (alternative to Vector)
    # Tenant: {{ include "logclaw.tenantId" . }}
    # Generated by Helm chart version {{ .Chart.Version }}
    # =========================================================================

    # ---------------------------------------------------------------------------
    # SYSTEM settings
    # ---------------------------------------------------------------------------
    <system>
      log_level info
      workers 4
    </system>

    # ---------------------------------------------------------------------------
    # SOURCES
    # ---------------------------------------------------------------------------

    # Tail Kubernetes container logs from host filesystem
    <source>
      @type tail
      @id input_kubernetes_tail
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head false
      <parse>
        @type multi_format
        <pattern>
          format json
          time_key time
          time_format %Y-%m-%dT%H:%M:%S.%NZ
        </pattern>
        <pattern>
          format /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/
          time_format %Y-%m-%dT%H:%M:%S.%N%:z
        </pattern>
      </parse>
    </source>

    # Forward receiver — accepts forwarded log streams from other Fluentd agents
    <source>
      @type forward
      @id input_forward
      port 24224
      bind 0.0.0.0
    </source>

    # Monitor agent metrics
    <source>
      @type monitor_agent
      @id input_monitor
      bind 0.0.0.0
      port 24220
    </source>

    # ---------------------------------------------------------------------------
    # FILTERS
    # ---------------------------------------------------------------------------

    # Enrich with Kubernetes pod/namespace metadata
    <filter kubernetes.**>
      @type kubernetes_metadata
      @id filter_kube_metadata
      kubernetes_url https://kubernetes.default.svc
      verify_ssl true
      skip_labels false
      skip_container_metadata false
      skip_master_url false
      skip_namespace_metadata false
    </filter>

    # Add LogClaw-specific metadata fields
    <filter kubernetes.**>
      @type record_transformer
      @id filter_add_logclaw_metadata
      enable_ruby true
      <record>
        tenant_id "{{ include "logclaw.tenantId" . }}"
        ingest_timestamp ${Time.now.utc.strftime('%Y-%m-%dT%H:%M:%S.%LZ')}
        logclaw_chart_version "{{ .Chart.Version }}"
        logclaw_component "fluentd"
      </record>
    </filter>

    # ---------------------------------------------------------------------------
    # SAMPLING (drop-sampling to reduce Kafka load)
    # ---------------------------------------------------------------------------

    # Sample DEBUG events at 1%
    <filter kubernetes.**>
      @type sampling_filter
      @id filter_sample_debug
      interval 100
      sample_unit "message"
      <condition>
        key level
        value DEBUG
      </condition>
    </filter>

    # Sample INFO events at 10%
    <filter kubernetes.**>
      @type sampling_filter
      @id filter_sample_info
      interval 10
      sample_unit "message"
      <condition>
        key level
        value INFO
      </condition>
    </filter>

    # ---------------------------------------------------------------------------
    # OUTPUT — Kafka sink
    # ---------------------------------------------------------------------------
    <match kubernetes.**>
      @type kafka2
      @id output_kafka
      brokers {{ include "logclaw.kafkaBrokers" . }}
      topic_key logclaw_topic
      default_topic {{ include "logclaw.kafkaRawLogsTopic" . }}
      use_event_time true
      required_acks 1
      compression_codec lz4

      <format>
        @type json
      </format>

      <buffer topic>
        @type file
        path /var/log/fluentd-buffers/kafka.buffer
        flush_mode interval
        flush_interval {{ .Values.sink.kafka.lingerMs }}ms
        flush_thread_count 2
        overflow_action block
        total_limit_size 512m
        chunk_limit_size 10m
        retry_type exponential_backoff
        retry_wait 1s
        retry_max_interval 30s
        retry_timeout 1h
      </buffer>
    </match>

    # Catch-all for unmatched tags — prevents log loss
    <match **>
      @type null
      @id output_null_catchall
    </match>
{{- end }}
