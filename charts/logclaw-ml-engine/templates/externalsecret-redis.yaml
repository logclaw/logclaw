{{- if .Values.mlEngine.redis.bundled }}
{{- /*
  ExternalSecret â€” syncs the Redis password from the secret store into the
  cluster Secret referenced by the Bitnami Redis sub-chart:
    .Values.redis.auth.existingSecret
  Path in the external store:
    logclaw/<tenantId>/ml-engine/redis-password
*/}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "logclaw-ml-engine.fullname" . }}-redis-es
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "logclaw-ml-engine.labels" . | nindent 4 }}
    app.kubernetes.io/component: secret-sync
spec:
  # Refresh every 5 minutes so rotation is picked up promptly.
  refreshInterval: "5m"
  secretStoreRef:
    # ClusterSecretStore named "logclaw-vault" is expected to be pre-installed
    # by the platform team.  Override with:
    #   --set externalSecret.secretStoreName=<name>
    #   --set externalSecret.secretStoreKind=SecretStore
    name: {{ .Values.externalSecret.secretStoreName | default "logclaw-vault" }}
    kind: {{ .Values.externalSecret.secretStoreKind | default "ClusterSecretStore" }}
  target:
    name: {{ .Values.redis.auth.existingSecret }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "logclaw-ml-engine.labels" . | nindent 10 }}
  data:
    - secretKey: {{ .Values.redis.auth.existingSecretPasswordKey }}
      remoteRef:
        key: "logclaw/{{ include "logclaw-ml-engine.tenantId" . }}/ml-engine/redis-password"
        property: "password"
{{- end }}
